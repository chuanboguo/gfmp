# DLMTOOL OPERATING MODEL {#app:dlmtool-om}

<!-- *A summary of the important features of the DLMtool operating model* -->

<!-- *Draw on appendix of DLMtool paper but simplified to have one region* -->

<!-- *Not too many details; reference the paper* -->

The DLMtool population dynamics operating model (OM) is an age-structured model decribed below. The OM is very flexible, with options to allow a number of parameters (e.g., natural mortality, growth, selectivity) to vary through time.
Multiple sub-areas can also be described, and outcome uncertainty can be represented through the addition of implementation bias parameters.
A full range of possible parameterizations is described in the appendices of @carruthers2018.
Here we present the simplest version of the OM, without time-varying parameters, multiple sub-areas or implementation bias. This OM structure should be suitable as a base OM for most species intended to be assessed with the framework. 
More complex structural assumptions, including time-varying parameters, could be developed as scenarios when justified for individual species.
Wherever possible, we follow the notation conventions used in the appendices of @carruthers2018 for consistency.

*TODO: Do we agree on these names for the milestone years??*

There are two distinct time-periods in the simulation framework: (1) The historical period, which covers the years from the first year of the catch time-series $t_1$ to the final year of the catch time series $t_c$; and (2) the projection period, which covers the period from the first year after $t_c$, to the final projection year $t_N$. 
The historical period is calibrated to historical observations uing an age-structured stock reduction analysis (SRA) [@kimura1982; @walters2006], described in Appendix \@ref(app:sra).
The closed-loop simulations and calculation of performance metrics begin in year $t_{c+1}$.

Operating model development in the MP Framework follows three steps:

1. Set parameter values and ranges in the DLMtool OM (OM equations in this appendix; default parameter settings in Appendix \@ref(app:default-slots); examples of user-defined parameter settings in Appendices \@ref(app:desc-om-rex) and \@ref(app:desc-om-sr));

2. Pass the OM parameters to the `SRA_scope` function in MSEtool, which fits an age-structured SRA  to historical observed catches and indices of abundance (and to age- and length-composition data if available). 
This results in calibrated estimates of model parameters, and estimates of historical biomass and historical fishing mortality that are consistent with historical observations. 
Equations for the `SRA_scope` model are provided in Appendix \@ref(app:sra); then

3. Pass the calibrated parameter values back to the DLMtool OM for use in the closed-loop simulation projections.


## POPULATION DYNAMICS MODEL  {#sec:dlmtool-pop-dynamics}

<!-- Last historical year, the ``current'' year is denoted by $c$. -->

### Growth and maturity

The operating model assumes that growth follows a von Bertalanffy model:

\begin{equation}
L_{y,a} = L_{\infty}\left( 1 - \exp( - \kappa(a - a_{0} \right))
(\#eq:dlm-om-vonb)
\end{equation}

where ${\kappa}$ represents the growth rate, $L_{\infty}$ represents the maximum length and $a_0$ represents the theoretical age where length is zero.

Weight-at-age ($W_a$) is  assumed to be related to length-at-age ($L_a$) by:

\begin{equation}
W_{y,a} = \beta_{W}\ {L_{a}}^{\alpha_{W}}.
(\#eq:dlm-om-wta)
\end{equation}

Maturity is specified according to length, using a logistic model with parameters describing length-at-50% maturity ($\theta_{l50}$) and the length increment to 95% maturity ($\theta_{l50-95}$). Maturity-at-length ($m_l$) is then calculated as:

\begin{equation}
m_{l} = \frac{1}{1 + e^{{- \ln}19\left( \frac{l - \mathrm{\Delta}_{l50} \cdot L_{\infty}}{{{\theta}}_{l50-95}} \right)}},
(\#eq:dlm-om-matl)
\end{equation}

and maturity-at-age is calculated using the length-at-age:

\begin{equation}
m_{a} = \frac{1}{1 + e^{{- \ln}19\left( \frac{a - \theta_{a50}}{\theta_{a95} - \theta_{a50}} \right)}}
(\#eq:dlm-om-mata)
\end{equation}

where \(\theta_{a50}\) and \(\theta_{a95}\) represent the age at 50% and 95% maturity given by the inverse von-Bertalanffy growth curve:

\begin{equation}
\theta_{a50} = \frac{- \ln\left( 1 - \mathrm{\Delta}_{l50} \right)}{\kappa} + t_{0}
(\#eq:dlm-om-invonb)
\end{equation}

\begin{equation}
\theta_{a95} = \frac{- \ln\left( 1 - \left( \mathrm{\Delta}_{l50} + \frac{{{\theta}}_{l50\_ 95}}{L_{\infty}} \right) \right)}{\kappa} + t_{0}
(\#eq:dlm-om-theta95)
\end{equation}

### Population dynamics
Leading parameters of the population dynamics model, defined as fixed values or ranges by the user, are: unfished recruitment \({{R}}_{0}\), the steepness parameter of the stock-recruit relationship ($h$) [@mace1988], and natural mortality ($M$).

Recruitmment and numbers-at-age are initialized in the first historical year using the SRA model (Appendix \@ref(app:sra), Equations \@ref(eq:dlm-sra-numinit) and \@ref(eq:dlm-sra-recinit)).

During the projection period (years $y$ = $t_{c+1}$ to $y$ = $t_N$), the number of fish recruited to the first age group in each year $N_{y,a=1}$
is calculated as a function of last year's spawning biomass \(S_{y-1}\), assuming a Beverton-Holt stock-recruit relationship with annual
lognormal recruitment deviations $\varepsilon_{R,y-1}$:

\begin{equation}
N_{y, a = 1} = \left( \frac{4 {h} R_{0} S_{y-1}} {S_{0}  \left( 1 - {h} \right) + \left( 5{h} - 1 \right) S_{y-1}} \right) \cdot \varepsilon_{R,y-1},
(\#eq:dlm-om-recy)
\end{equation}

where unfished spawning biomass \(S_{0}\) is calculated as the
sum over ages of the maturity at age $m_a$, weight at age
$W_a$, and unfished numbers at age  \({{\ {R}}_{0}\ e^{\sum_{i = 1}^{a}M_{i}}}\):

\begin{equation}
S_{0} = \sum_{a = 1}^{n_{a}}{m_{a}\ W_{a}{\ {R}}_{0}\ e^{\sum_{i = 1}^{a}M_{i}}}.
(\#eq:dlm-om-so)
\end{equation}

and spawning biomass $S_{y}$ in a given year is the
sum over ages of the spawning biomass over ages of the maturity at age $m_a$, weight at age
$W_a$, and numbers at age $N_{y,a}$:

\begin{equation}
S_{y} = \sum_{a = 1}^{n_{a}}{m_{a}W_{a}N_{y,a}}.
(\#eq:dlm-om-sy)
\end{equation}

Annual recruitment deviations ($\varepsilon_{R,y}$) are generated by first sampling from a lognormal distribution with mean $1$ and standard deviation \({{\sigma}}_{R}\):

\begin{equation}
\varepsilon_{R,y}\sim \mathrm{Lognormal}\left( 1,{{\sigma}}_{R} \right),
(\#eq:dlm-om-recdev)
\end{equation}

Temporal autocorrelation \({{\theta}}_{\textrm{AC}}\) is added to these initial draws ($\dot{\varepsilon}_{R,y}$) as:

\begin{equation}
\varepsilon_{R,y} = {{\theta}}_{\textrm{AC}}{\ \dot{\varepsilon}}_{R,y - 1} + {\ \dot{\varepsilon}}_{R,y}\sqrt{\left( 1 - {{{\theta}}_{\textrm{AC}}}^{2} \right)},
(\#eq:dlm-om-auto)
\end{equation}

where $\theta_{\mathrm{AC}}$ represents a first-order autocorrelation term, where the user defines \({{\theta}}_{\textrm{AC}}\), and setting \({{\theta}}_{\textrm{AC}}\) to zero implies no autocorrelation.

The number of fish $N$ in each year $y$ > $t_c$ and age $a$ > 1 is calculated from the previous year and age class,
subject to the instantaneous total mortality rate-at-age $Z_{a}$:

\begin{equation}
N_{y + 1,a + 1} = N_{a}e^{- Z_{a}} 
(\#eq:dlm-om-numa)
\end{equation}

Total mortality rate $Z_{y,a}$ is the sum of the instantaneous rates of natural mortality ($M$), assumed constant across years and ages unless otherwise specified, and fishing mortality-at-age ($F_{y,a}$; Equation \@ref(eq:Fay)).

\begin{equation}
Z_{y,a} = M + F_{y,a}.
(\#eq:dlm-om-z)
\end{equation}

## FISHING DYNAMICS {#sec:dlmtool-fishing-dynamics}

During the projection period, the rate of fishing mortality-at-age ($F_{y,a}$) is calculated from the TAC prescribed by the MP ($\textrm{TAC}_{\mathrm{MP},y}$).
To distribute catches over ages it is first necessary to calculate the distribution of vulnerable biomass across ages:

\begin{equation}
V_{y,a} = N_{y,a} W_{a} s_{a} R_{a}
(\#eq:dlm-om-vulcom)
\end{equation}

The realized projected catches $C_{y,a}$ are the TAC recommendations across ages. 
Projected catches may account for retention rate ($R_{y,a}$) and post-release discard mortality rate $\theta_{M{\textrm{disc}}}$ in the presence of discarding.
Implementation error ($I_\textrm{TAC}$) may also be accounted for:

\begin{equation}
C_{y,a} = \frac{V_{y,a}} {\sum_{a}^{n_{a}}V_{y,a}}
\textrm{TAC}_{\mathrm{MP},y}\ I_{\mathrm{TAC},y}\
\frac{R_{y,a} + \left( 1 - R_{a} \right)
{{\theta}}_{\textrm{Mdisc}}}{R_{a}}
(\#eq:dlm-om-cata)
\end{equation}

where ($I_\textrm{TAC}$) is user-defined (slot **TODO**), and the overall retention rate-at-age $R_a$, is a combination of an age-specific retention $r_a$ with a maximum value of $1$ (Equation **TODO**), and a constant rate of discarding \(\gamma\):

\begin{equation}
R_{a} = r_{a}\ (1 - \gamma).
(\#eq:dlm-om-retention)
\end{equation}

Fishing mortality rates are then calculated from the realized catches $C_{y,a}$
subject to the constraint that they do not exceed user-specified
${F_\textrm{max}}$:

\begin{equation}
F_{y,a} = \min \left( - \ln\left( 1 - \frac{C_{y,a}}{N_{y,a}{W}_{a}} \right),F_{\max} \right).
(\#eq:dlm-om-Fay)
\end{equation}

*TODO. Sort out the best place to put the vulnerability equations*

The vulnerability-at-age $s_{a}$ is calculated from a double-normal selectivity curve and length-at-age:



<!-- s_{y,a} = \left\{ \begin{matrix} -->
<!-- 2^{- \ \frac{{(L_{y,a} - {\widetilde{L}}_{\textrm{smax}})}^{2}}{\sigma_{\textrm{sasc}}^{2}}} & L_{y,a} \leq {\widetilde{L}}_{\textrm{smax}} \\ -->
<!-- 2^{- \ \frac{{(L_{y,a} - {\widetilde{L}}_{\textrm{smax}})}^{2}}{\sigma_{\textrm{sdesc}}^{2}}} & L_{y,a} > {\widetilde{L}}_{\textrm{smax}} \\ -->
<!-- \end{matrix} \right -->

The length at maximum selectivity \(L_{\textrm{smax}}\) is
user-defined. The standard deviation parameters of the
ascending limb is given by user-specified length at 5%
vulnerability \({L}_{5}\):

$$
\sigma_{\textrm{sasc}}^{2} = \frac{{{L}}_{5} - {{L}}_{\textrm{smax}}}{\sqrt{- \log_{2^{0.05}}}}
$$

While the standard deviation of the descending limb is given by user-specified vulnerability \({V}_{\overline{L}} \) of fish of
length \(\overline{L}\):

$$
\sigma_{\textrm{sdesc}}^{2} = \frac{\overline{L} - {{L}}_{\textrm{smax}}}{\sqrt{- \log_{2^{{{V}}_{\overline{L}}}}}}
$$

Age-specific retention $r_a$, is modelled using the same double-normal curve as selectivity:

*TODO*
<!-- \(r_{y,a} = \left\{ \begin{matrix} -->
<!-- 2^{- \ \frac{{(L_{y,a} - {\widetilde{L}}_{\textrm{rmax}})}^{2}}{\sigma_{\textrm{rasc}}^{2}}} & L_{y,a} \leq {\widetilde{L}}_{\textrm{rmax}} \\ -->
<!-- 2^{- \ \frac{{(L_{y,a} - {\widetilde{L}}_{\textrm{rmax}})}^{2}}{\sigma_{\textrm{rdesc}}^{2}}} & L_{y,a} > {\widetilde{L}}_{\textrm{rmax}} \\ -->
<!-- \end{matrix} \right.\ \) -->


The length at maximum retention \({L}_{\textrm{rmax}}\) is
user-specified. The standard deviation parameters of the
ascending limb is given by user-specified length at 5% retention
\({r}_{5}\):

$$
\sigma_{\textrm{rasc}}^{2} = \frac{{{r}}_{5} - {L}_{\textrm{rmax}}}{\sqrt{- \log_{2^{0.05}}}}
$$

While the standard deviation of the descending limb is given by
user-specified retention \({{r}}_{\overline{L}} \) of fish of
length \(\overline{L}\):

$$
\sigma_{\textrm{rdesc}}^{2} = \frac{\overline{L} - {{L}}_{\textrm{rmax}}}{\sqrt{- \log_{2^{{{r}}_{\overline{L}}}}}}
$$

