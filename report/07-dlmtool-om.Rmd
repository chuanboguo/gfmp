# DLMTOOL OPERATING MODEL {#app:dlmtool-om}

The population dynamics operating model (OM), as implemented in DLMtool, is an age-structured model decribed below.
The OM is flexible, with options to allow a number of parameters (e.g., natural mortality, growth, selectivity) to vary through time.
Multiple sub-areas can also be described, and outcome uncertainty can be represented through the addition of implementation uncertainty and bias parameters.
A full range of possible parameterizations is described in the appendices of @carruthers2018, adapted here for the MP Framework.
Here, we present the simplest version of the OM, without time-varying parameters, multiple sub-areas, or implementation bias.
This OM structure should be suitable as a base OM for most species intended to be assessed with the framework.
More complex structural assumptions, including time-varying parameters, could be developed as scenarios when justified for individual stocks.
Wherever possible, we follow the notation conventions used in the appendices of @carruthers2018 for consistency.

There are two distinct time-periods in the simulation framework:
(1) The historical period, which covers the years from the first year of the catch time-series $t_1$ to the final year of the catch time series $t_c$ (where "c" represents the "current" year); and
(2) the projection period, which covers the period from the first year after $t_c$ to the final projection year $t_N$.
The historical period is calibrated to historical observations using an age-structured stock-reduction analysis [SRA; @kimura1982; @walters2006], described in Appendix \@ref(app:sra).
The closed-loop simulations and calculation of performance metrics begin in year $t_{c+1}$.

Operating model development in the MP Framework follows three steps:

1. Set parameter values and ranges in the OM (OM equations in this appendix; default parameter settings in Appendix \@ref(app:default-slots); examples of user-defined parameter settings in Appendix \@ref(app:desc-om-rex).

2. Pass the OM parameters to the SRA model, which conditions the OM by fitting an age-structured SRA to historical observed catches and indices of abundance (and to age- and length-composition data if available).
This results in calibrated estimates of model parameters, and estimates of historical biomass and historical fishing mortality that are consistent with historical observations.
Equations for the SRA model are provided in Appendix \@ref(app:sra).

3. Pass the calibrated parameter values back to the OM (now the "conditioned" OM) for use in the closed-loop simulation projections.

## POPULATION DYNAMICS MODEL  {#sec:dlmtool-pop-dynamics}

<!-- Parameters for the population dynamics are included in the `Stock` object of DLMtool. -->

### Growth and maturity

The operating model assumes that growth follows a von Bertalanffy model:

$$
L_{y,a} = L_{\infty}\left( 1 - \exp( - \kappa(a - a_{0} \right))
(\#eq:dlm-om-vonb)
$$

where $\kappa$ represents the growth rate, $L_{\infty}$ represents the maximum length and $a_0$ represents the theoretical age where length is zero.

Weight-at-age ($W_a$) is assumed to be related to length-at-age ($L_a$) by:

$$
W_{y,a} = \beta_{W}\ {L_{a}}^{\alpha_{W}}.
(\#eq:dlm-om-wta)
$$

Maturity is specified according to length, using a logistic model with parameters describing length-at-50% maturity ($\theta_{l50}$) and the length increment from 50% to 95% maturity ($\theta_{l50-95}$). Maturity ($m$) at length ($l$) is then calculated as:

$$
m_{l} = \frac{1}{1 + e^{{- \ln}19\left( \frac{l - \theta_{l50}}{{{\theta}}_{l50-95}} \right)}},
(\#eq:dlm-om-matl)
$$

```{r, include=FALSE, eval=FALSE}
f <- function(l, theta_l50, theta_5095) {
  x <- 1 + exp(-log(19) * ((l - theta_l50) / theta_5095))
  1 / x
}
x <- seq(1, 100, length.out = 200)
plot(x, f(x, 50, 25))
```

where maturity ($m_a$) at age is calculated using the length-at-age:

$$
m_{a} = \frac{1}{1 + e^{{- \ln}19\left( \frac{a - \theta_{a50}}{\theta_{a95} - \theta_{a50}} \right)}}
(\#eq:dlm-om-mata)
$$

where \(\theta_{a50}\) and \(\theta_{a95}\) represent the age at 50% and 95% maturity given by the inverse von-Bertalanffy growth curve:

<!-- TODO: check these! -->
$$
\theta_{a50} = \frac{- \ln\left( 1 - \theta_{l50} / L_{\infty} \right)}{\kappa} + t_{0}
(\#eq:dlm-om-invonb)
$$

$$
\theta_{a95} = \frac{- \ln\left( 1 - \left( \theta_{l50} / L_{\infty} + {{\theta}}_{l50\_ 95} / L_{\infty} \right) \right)}{\kappa} + t_{0}
(\#eq:dlm-om-theta95)
$$

### Population dynamics

Leading parameters of the population dynamics model, defined as fixed values or ranges by the user, are: unfished recruitment $R_0$, the steepness parameter of the stock-recruit relationship ($h$) [@mace1988], and natural mortality ($M$).

Recruitment and numbers-at-age are initialized in the first historical year using the SRA model (Appendix \@ref(app:sra), Equations \@ref(eq:sra-om-numinit) and \@ref(eq:sra-om-recinit)).

During the projection period (years $y = t_{c+1}$ to $y = t_N$), the number of fish recruited to the first age group in each year $N_{y,a=1}$ is calculated as a function of previous year's spawning biomass $B_{y-1}$, assuming a Beverton-Holt stock-recruit relationship [@beverton1957] with annual lognormal recruitment deviations $\varepsilon_{R,y-1}$:

$$
N_{y, a = 1} = \left( \frac{4 {h} R_{0} B_{y-1}} {B_{0}  \left( 1 - {h} \right) + \left( 5{h} - 1 \right) B_{y-1}} \right) \varepsilon_{R,y-1},
(\#eq:dlm-om-recy)
$$

<!--TODO: Add Ricker eq -->

where unfished spawning biomass \(B_{0}\) is calculated as the
sum over ages of the maturity at age $m_a$, weight-at-age
$W_a$, and unfished numbers at age  \({{\ {R}}_{0}\ e^{\sum_{i = 1}^{a}M_{i}}}\):

$$
B_{0} = \sum_{a = 1}^{n_{a}}{m_{a}\ W_{a}{\ {R}}_{0}\ e^{\sum_{i = 1}^{a}M_{i}}}.
(\#eq:dlm-om-bo)
$$

and spawning biomass $B_y$ in a given year is the sum over ages of the maturity-at-age $m_a$, the weight-at-age $W_a$, and numbers at age $N_{y,a}$:

$$
B_{y} = \sum_{a = 1}^{n_{a}}{m_{a}W_{a}N_{y,a}}.
(\#eq:dlm-om-sy)
$$

Annual recruitment deviations ($\varepsilon_{R,y}$) are generated by first sampling from a lognormal distribution with mean $1$ and standard deviation $\sigma_R$:

$$
\varepsilon_{R,y}\sim \mathrm{Lognormal}\left( 1,{{\sigma}}_{R} \right),
(\#eq:dlm-om-recdev)
$$

Temporal autocorrelation $\theta_\textrm{AC}$ is added to these initial draws ($\varepsilon_{R,y}$) as:

$$
\varepsilon_{R,y} = {{\theta}}_{\textrm{AC}}\varepsilon_{R,y - 1} + \varepsilon_{R,y}\sqrt{\left( 1 - {{{\theta}}_{\textrm{AC}}}^{2} \right)},
(\#eq:dlm-om-auto)
$$

where $\theta_{\textrm{AC}}$ represents a first-order autocorrelation term, and setting $\theta_\textrm{AC}$ to zero implies no autocorrelation.

The number of fish $N$ in each year $y > t_c$ and age $a > 1$ is then calculated from the numbers in the previous year and age class, subject to the instantaneous total mortality rate ($Z$) at age ($a$):

$$
N_{y + 1, a + 1} = N_ae^{- Z_a}
(\#eq:dlm-om-numa)
$$

where the total mortality rate $Z_{y,a}$ is the sum of the instantaneous rates of natural mortality ($M$), assumed constant across years and ages unless otherwise specified, and fishing mortality-at-age ($F_{y,a}$, defined in Equation \@ref(eq:dlm-om-Fay)):

$$
Z_{y,a} = M + F_{y,a}v_{y,a}.
(\#eq:dlm-om-z)
$$

where $v_{y,a}$ is vulnerability-at-age, defined in Equation \@ref(eq:dlm-om-vay).

## FLEET DYNAMICS {#sec:dlmtool-fleet-dynamics}

<!-- Parameters for the fleet dynamics are included in the `Fleet` object of DLMtool. -->
During the projection period, the rate of fishing mortality-at-age ($F_{y,a}$) is calculated from the TAC prescribed by the MP ($\textrm{TAC}_{\mathrm{MP},y}$).
To distribute catches over ages it is first necessary to calculate the distribution of vulnerable biomass across ages ($V_{y,a}$):

$$
V_{y,a} = N_{y,a} W_{a} v_{a} R_{a}
(\#eq:dlm-om-vulcom)
$$

where the vulnerability-at-age  $v_{y,a}$ is calculated from a double-normal selectivity curve and length-at-age:

<!--
$$
v_{y,a} = \left\{ \begin{matrix}
2^{- \ \frac{{(L_{y,a} - {{L}}_{\textrm{smax}})}^{2}}{\sigma_{\textrm{sasc}}^{2}}} & L_{y,a} \leq {{L}}_{\textrm{smax}} \\
2^{- \ \frac{{(L_{y,a} - {{L}}_{\textrm{smax}})}^{2}}{\sigma_{\textrm{sdesc}}^{2}}} & L_{y,a} > {{L}}_{\textrm{smax}} \\
\end{matrix} \right,
(\#eq:dlm-om-vay)
$$
-->

and $L_{\textrm{smax}}$ represents the shortest length that is fully vulnerable to fishing.
The standard deviation parameters of the ascending limb are given by the length at 5% vulnerability ($L_5$):

$$
\sigma_{\textrm{sasc}}^{2} = \frac{{{L}}_{5} - {{L}}_{\textrm{smax}}}{\sqrt{- \log_{2^{0.05}}}}
(\#eq:dlm-om-siglasc)
$$

While the standard deviation of the descending limb is given by the vulnerability \({V}_{\overline{L}} \) of fish of mean length \(\overline{L}\):

$$
\sigma_{\textrm{sdesc}}^{2} = \frac{\overline{L} - {{L}}_{\textrm{smax}}}{\sqrt{- \log_{2^{{{V}}_{\overline{L}}}}}}
(\#eq:dlm-om-sigldes)
$$

The realized projected catches $C_{y,a}$ are the TAC recommendations across ages.
Projected catches may account for retention rate ($R_{y,a}$) and post-release discard mortality rate $\theta_{M{\textrm{disc}}}$ in the presence of discarding.
Implementation uncertainty ($I_\textrm{TAC}$, Equation \@ref(eq:dlm-om-itac)) may also be accounted for, e.g., in the presence of consistent under-utilization of TACs.

$$
C_{y,a} = \frac{V_{y,a}} {\sum_{a}^{n_{a}}V_{y,a}}
\textrm{TAC}_{\mathrm{MP},y}\ I_{\mathrm{TAC},y}\
\frac{R_{y,a} + \left( 1 - R_{a} \right)
{{\theta}}_{\textrm{Mdisc}}}{R_{a}}
(\#eq:dlm-om-cata)
$$

where ($I_\textrm{TAC}$) is user-defined, and the overall retention rate-at-age $R_a$, is a combination of an age-specific retention $r_{y,a}$ with a maximum value of $1$ (Equation \@ref(eq:dlm-om-ray)), and a constant rate of discarding \(\gamma\):

$$
R_{a} = r_{a}\ (1 - \gamma).
(\#eq:dlm-om-retention)
$$

where age-specific retention $r_{y,a}$, is modelled using the same form of double-normal curve as selectivity:

$$
r_{y,a} = \left\{ \begin{matrix}
2^{- \ \frac{{(L_{y,a} - {{L}}_{\textrm{rmax}})}^{2}}{\sigma_{\textrm{rasc}}^{2}}} & L_{y,a} \leq {{L}}_{\textrm{rmax}} \\
2^{- \ \frac{{(L_{y,a} - {{L}}_{\textrm{rmax}})}^{2}}{\sigma_{\textrm{rdesc}}^{2}}} & L_{y,a} > {{L}}_{\textrm{rmax}} \\
\end{matrix} \right\}
(\#eq:dlm-om-ray)
$$

where \({L}_{\textrm{rmax}}\) is the length at maximum retention.
The standard deviation parameters of the ascending limb is given by the length at 5% retention \({r}_{5}\):

$$
\sigma_{\textrm{rasc}}^{2} = \frac{{{r}}_{5} - {L}_{\textrm{rmax}}}{\sqrt{- \log_{2^{0.05}}}}
(\#eq:dlm-om-sigrasc)
$$

While the standard deviation of the descending limb is given by retention \({{r}}_{\overline{L}} \) of fish of length \(\overline{L}\):

$$
\sigma_{\textrm{rdesc}}^{2} = \frac{\overline{L} - {{L}}_{\textrm{rmax}}}{\sqrt{- \log_{2^{{{r}}_{\overline{L}}}}}}
(\#eq:dlm-om-sigrdec)
$$

Fishing mortality rates are then calculated from the realized catches $C_{y,a}$ subject to the constraint that they do not exceed ${F_\textrm{max}}$:

$$
F_{y,a} = \min \left( - \ln\left( 1 - \frac{C_{y,a}}{N_{y,a}{W}_{a}} \right),F_{\max} \right).
(\#eq:dlm-om-Fay)
$$

The parameter ${F_\textrm{max}}$ can be adjusted, but is set to 3 by default.

## OBSERVATION DYNAMICS

<!-- Parameters for observation dynamics are included in the `Obs` object of DLMtool. -->
The observation dynamics emulate the collection of data for use in the MPs.
Two fundamental types of data are simulated by the OM: (1) time series data (e.g. annual
catches from 1970--2017); and (2) catch composition data (e.g., length or age samples).

### Time series data

Time series data are simulated with various types of error that would be expected from real-life sampling of fisheries data (e.g., lognormal observation error in indices of abundance).
Annual observed indices of abundance are calculated by adding observation error and bias to annual relative total biomass ($B_{y}$) through a term $\omega_{I,y}$ that includes bias and imprecision in the index observations:

$$
I_{y}^{\textrm{obs}} = \omega_{I,y}\frac{{B_{y}}^{\beta}}{\frac{1}{y}\sum_{i = 1}^{y}{B_{i}}^{\beta}}
(\#eq:dlm-om-iy)
$$

where $B^T_{y}$ is total biomass given by the sum over ages of the weight-at-age $W_a$, and numbers at age $N_{y,a}$:

$$
B^T_{y} = \sum_{a = 1}^{n_{a}}{W_{a}N_{y,a}}
(\#eq:dlm-om-by)
$$

and where $\beta$ is the hyperstability/hyperdepletion parameter.
When $\beta$ is 1 the index is linearly related to spawning biomass $S_y$.
When $\beta$ is greater than 1 the index is hyperdeplete and moves faster than true spawning biomass changes.
When $\beta$ is lower than 1 the index is hyperstable and moves slower than true spawning biomass changes.
When the observed index is calculated, it is normalised to have a mean value of 1 over all years.

The term $\omega_{I,y}$ represents imprecision in observations via $\sigma_I$:

$$
\omega_{I,y} = \exp \left( \varepsilon_{I,y} - \frac{{{\sigma}}_{I}}{2} \right),
(\#eq:dlm-om-omegai)
$$

where the lognormal error term $\epsilon$, is drawn from a standard normal distribution whose standard deviation $\sigma_I$ is sampled at random in each simulation:

$$
\varepsilon_{I,y}\sim \textrm{Normal}\left( 0,{{\sigma}}_{I} \right)
(\#eq:dlm-om-epsiloni)
$$

<!--
By default the OM samples simulation-specific observation error
${{\sigma}}_{I}$ from a uniform distribution.
-->

<!--TODO: the above text will need to be modified to reflect that sigma comes from conditioning in the SRA. Still to determine whether it will come from historical observed index or from residuals in SRA fit to historical observed index-->

<!--
$$
{\sigma}_{I}\sim \textrm{Uniform}\left( \textrm{LB}_{I},\textrm{UB}_{I} \right).
(\#eq:dlm-om-sigi)
$$
-->

<!--
This approach means that the OM can specify a time series with a low degree of error (e.g., low sampled values of ${\sigma}_{I}$ specified by lower $\textrm{LB}_I$ and $\textrm{UB}_I$), or a large degree of error (e.g., large sampled values of ${\sigma}_{I}$ specified by higher $\textrm{LB}_I$ and $\textrm{UB}_I$).
-->

### Catch composition data

<!-- TODO: I don't think we use CAL anywhere. If so can simplify the description below to be only in terms of CAA because we haven't anywhere defined how CAL is generated by the model-->

Two types of catch composition observations are simulated, catches-by-age-class-by-year (CAA) and catches-by-length-class-by-year (CAL).
Although we do not propose any provisional MPs that use CAA or CAL, future applications may explore the value of information related to aging fish otoliths.
Therefore, we describe the observation model component of CAA.
We do not describe the observation model of CAL at this time.

The observation model for CAA uses a simple multinomial distribution that accounts
for effective sample size (the number of independent observations).
For CAA observation models, the OM specifies an average annual
number of samples (number of individuals measured, for example) and the
annual effective sample size ($C_{y,a}^{\textrm{obs}}$).
For example, $\textrm{ESS}_\textrm{CAA}$ independent catch
samples-at-age (e.g., 20 per year) are sampled in proportion $p$ to the
catches-at-age predicted by the model ($C_{y,a}$, Equation \@ref(eq:dlm-om-cata)):

$$
C_{y,a}^{\textrm{obs}}\sim \textrm{Multinomial}\left( \textrm{ESS}_{\textrm{CAA}},p_{a} = \ \sum_{r}^{n_{r}}C_{y,a,r} \right)
(\#eq:dlm-om-cataobs)
$$

For each year, the frequency of samples at age is inflated to match the
total sample size $n_\textrm{CAA}$ and rounded to the nearest integer ($\textrm{nint}$):

$$
C_{y,a}^{\textrm{obs}} = \textrm{nint}\left( \ \frac{{{C}}_{y,a}^{\textrm{obs}}\ n_{\textrm{CAA}}}{\textrm{ESS}_{\textrm{CAA}}} \right)
(\#eq:dlm-om-cataobs-freq)
$$

Due to rounding, this model generates frequency-at-age data that are approximately equal to the average annual sample size:

$$
\sum_{a}^{n_{a}}{C_{y,a}^{\textrm{obs}}\ } \approx n_{\textrm{CAA}}
(\#eq:dlm-om-cataobs-equality)
$$

## IMPLEMENTATION DYNAMICS

<!-- Parameters for implementation dynamics are included in the `Imp` object of DLMtool.-->
<!--The OM includes three types of implementation error-->
<!--, which relate to MPs that provide management advice in terms of Total Allowable Catch (TAC), Total Allowable Effort (TAE) and size limits (SL).-->
This Framework only considers MPs that provide TAC advice for quota-managed groundfish fisheries.
Given that BC groundfish fisheries are subject to 100% at-sea and dockside observer coverage, we make the assumption that under-reporting of catch will be negligible in projection years.
However, for non-target species, there is a possibility that TACs will not be fully used.
The implementation uncertainty in TACs is applied in Equation \@ref(eq:dlm-om-cata).

The TAC implementation uncertainty term ($I_\textrm{TAC}$) is the product of a constant fraction of the TAC taken ${{b}}_{\textrm{TAC}}$ and a degree of inter-annual
variability controlled by ${{\sigma}}_{\textrm{TAC}}$.

$$
I_{\textrm{TAC},y} = {{b}}_{\textrm{TAC}}\textrm{\ exp}\left( \varepsilon_{\textrm{TAC},y} - \frac{{{\sigma}}_{\textrm{TAC}}^2}{2} \right)
(\#eq:dlm-om-itac)
$$

where ${{b}}_{\textrm{TAC}}$ is an improper fraction (e.g. ${{b}}_{\textrm{TAC}}$ = 0.7 is equivalent to 30% catch underages) and the lognormal error term $\varepsilon_{\textrm{TAC},y}$, is drawn from a standard normal distribution whose standard deviation ${\sigma}_{\textrm{TAC}}$ is sampled at random in each simulation:

$$
\varepsilon_{TAC,y}\sim \textrm{Normal}\left( 0,{{\sigma}}_{\textrm{TAC}}^2 \right)
(\#eq:dlm-om-epsilontac)
$$

By default the OM samples simulation-specific variability
${{\sigma}}_{\textrm{TAC}}$ from a uniform distribution.

$$
\sigma_{\textrm{TAC}}\sim \textrm{Uniform}\left( \textrm{LB}_{\textrm{TAC}},\textrm{UB}_{\textrm{TAC}} \right)
(\#eq:dlm-om-sigmatac)
$$

and mean fraction of recommendation $b_{\textrm{TAC}}$ from
a lognormal distribution:

$$
b_{\textrm{TAC}} = \exp\left( \varepsilon_{\textrm{bTAC}} - \frac{\sigma_{\textrm{bTAC}}^2}{2} \right)
(\#eq:dlm-om-btac)
$$

$$
\varepsilon_{\textrm{bTAC}}\sim \textrm{Normal}\left( 0,\sigma_{\textrm{bTAC}}^2 \right)
(\#eq:dlm-om-epsilonbtac)
$$

## CALCULATION OF MSY-BASED REFERENCE POINTS

Biological reference points (BRPs) in the MP Framework are currently based on the provisional reference points recommended in Canada's PA Framework [@dfo2006; @dfo2009], where the limit reference point (LRP) is defined as the OM value of $0.4B_\textrm{MSY}$ and the Upper Stock Reference (USR) is defined as the OM value of $0.8B_\textrm{MSY}$.
$B_\textrm{MSY}$ is defined as the equilibrium spawning biomass $B^e$ that would occur if the stock were fished at the constant rate of fishing mortality $F^e$ that produces maximum sustainable yield $\textrm{MSY}$.

Calculation of BRPs is done using estimated parameters from the conditioning stage, described in Appendix \@ref(app:sra).
In the absence of annual variability in life history and/or selectivity parameters, $F_\textrm{MSY}$ is calculated by numerically solving for the value of equilibrium $F^e$ that maximizes the equilibrium yield $Y^e$

$$
Y^e = F^e R^e \phi_b,
(\#eq:dlm-om-yeq)
$$

where $R^e$ is equilibrium recruitment (Equation \@ref(eq:dlm-om-req)) and $\phi_b$ is equilibrium vulnerable biomass-per-recruit, defined in Equation \@ref(eq:dlm-om-phib) below.

In this framework, we assume a Beverton-Holt stock-recruit relationship [@beverton1957], although DLMtool also allows users to select the Ricker form [@ricker1954]:

$$
R^e =
\begin{cases}
      \dfrac{\alpha^{\textrm{B}}\phi_f - 1}{\beta^{\textrm{B}}\phi_f} & \textrm{Beverton-Holt}\\
      \dfrac{\log(\alpha^{\textrm{R}}\phi_f)}{\beta^{\textrm{R}}\phi_f} & \textrm{Ricker}
\end{cases}
(\#eq:dlm-om-req)
$$

where $\alpha^{\textrm{B}}$ and $\beta^{\textrm{B}}$ are the parameters of the Beverton-Holt stock recruit relationship, and $\alpha^{\textrm{R}}$ and $\beta^{\textrm{R}}$ are the parameters of the Ricker stock recruit relationship,  derived from user-defined parameters steepness ($h$) and $R_0$, where
$\alpha^{\textrm{B}} = \frac{4h}{(1-h)\phi_f^0}$,
$\beta^{\textrm{B}} = \frac{5h-1}{(1-h)B_0}$
and
$\alpha^{\textrm{R}} = \frac{(5h)^{1.25}}{\phi_f^0}$,
$\beta^{\textrm{R}} = \frac{\log(5h)}{B_0}$,
where $B_0$ is unfished spawning biomass, derived from $R_0$ (Equation \@ref(eq:dlm-om-bo)), and $\phi_f^0$ is unfished spawning biomass-per-recruit defined by setting $F^e=0$ in Equation \@ref(eq:dlm-om-phif).

Following the approach of @botsford1981, equilibrium spawning biomass-per-recruit is calculated

$$
\phi_f = \sum_{a=1}^A \iota_a W_a m_a
(\#eq:dlm-om-phif)
$$

where $\iota_a$ is equilibrium survivorship-at-age:

$$
   \iota_a=
      \begin{cases}
            1, & a=1 \\
            \iota_{a-1}e^{-Z^e_{a-1}}, & 1<a<A \\
            \dfrac{\iota_{a-1}e^{-Z^e_{a-1}}}{1-e^{-Z^e_{a}}} , & a=A\\
      \end{cases}
(\#eq:dlm-om-survivorship)
$$

where $Z^e_{a}$ is equilibrium total mortality-at-age:

$$
Z^e_{a} = M +  F^e_{a}v_{a}
(\#eq:dlm-om-zeq)
$$

Finally, using the same approach, $\phi_b$ is calculated

$$
\phi_b = \sum_{a=1}^A \iota_a W_a v_a
(\#eq:dlm-om-phib)
$$

<!--TODO: do we want to explain how DLMtool numerically solves for FMSY (e.g., Newton-Raphson algorithm or just leave it vague)? My preference is to leave it vague. there are lots of ways to do it and the details aren't really important as long as it works.-->

After numerically solving Equation \@ref(eq:dlm-om-yeq) for $F_\textrm{MSY}$, $B_\textrm{MSY}$ is calculated:

$$
B_{\textrm{MSY}} = \phi_f R^e
(\#eq:dlm-om-bmsy)
$$

with $F^e=F_\textrm{MSY}$ in Equation \@ref(eq:dlm-om-survivorship).

<!-- TODO: Do we want to say anything about cases where parameters are time-varying? The DLmtool guide mentions it. I would suggest leaving it out, as we might choose to do it a different way anyway if the FSERP project identifies a best approach ... -->

