\newpage

`r if(knitr:::is_latex_output()) '\\Appendices'`

`r if(!knitr:::is_latex_output()) '# (APPENDIX) Appendix {-}'`

# DATA-LIMITED MANAGEMENT PROCEDURES {#app:MPs}

## SELECTION OF CANDIDATE MANAGEMENT PROCEDURES BASED ON DATA REQUIREMENTS

```{r screening-table}
library(dplyr)
table_screening <- readr::read_csv(here::here("report/data/dlmtool-mps.csv")) %>%
  select(-Comment) %>%
  mutate(Candidate = ifelse(Candidate == "Y", "Yes", "No")) %>%
  mutate(`Reason for exclusion` =
      ifelse(is.na(`Reason for exclusion`), "", `Reason for exclusion`))

table_screening$`Management Procedure` <-
  sapply(table_screening$`Management Procedure`, function(x) {
  paste(paste0("\\texttt{", strsplit(x, " ")[[1]], "}"), collapse = " ")
})

table_screening$`Management Procedure` <- gsub("\\_", "\\\\_", table_screening$`Management Procedure`)

table_screening <- arrange(table_screening, desc(Candidate),
  `Reason for exclusion`, `Management Procedure`)

knitr::kable(table_screening,
  caption = "Management procedures, brief descriptions, and why they were or were not selected as candidates in our screening analysis.",
  booktabs = TRUE,
  longtable = TRUE,
  linesep = "\\addlinespace",
  escape = FALSE,
  format = "latex") %>%
  kableExtra::column_spec(column = 1, width = "4cm") %>%
  kableExtra::column_spec(column = 2, width = "5.5cm") %>%
  kableExtra::column_spec(column = 4, width = "3.5cm") %>%
  kableExtra::kable_styling(latex_options = "repeat_header",
    repeat_header_text = "", repeat_header_method = "replace") %>%
  sub("\\caption\\[\\]\\{\\}", "\\caption*{}", .)
```

## MANAGEMENT PROCEDURE DESCRIPTIONS

This is a brief review of the available TAC-based MPs in DLMtool that were selected as described in Table \@ref(tab:screening-table).

```{r, results='asis', include=FALSE, eval=FALSE}
mps <- DLMtool::MPtype(DLMtool::avail('MP')) %>%
  dplyr::filter(Recs == "TAC") %>%
  dplyr::filter(!MP %in% grep("CC[2-9]+", .$MP, value = TRUE) )
csasdown::csas_table(mps)
```

### `AvC`: Average catch

The mean historical catch is calculated and used to set a constant catch limit (TAC).

The TAC is calculated as:
$$
\textrm{TAC} = \frac{\sum_{y=1}^{n}C_y}{n}
$$

where $\mathrm{TAC}$ is the catch recommendation, $n$ is the number of historical years, and $C_y$ is the catch in historical year $y$.

### `CC`: Constant catch

The TAC is the average historical catch over the last 5 years [@geromont2015].

The TAC is calculated as:
$$
\textrm{TAC} = (1-x)C_{\textrm{ave}},
$$

where $x$ lies between 0 and 1, and $C_\textrm{ave}$ is average historical catch over the previous 5 years. The TAC is constant for all future projections. There are five variants of this procedure, which are the same besides the value of $x$:

- CC1: $x = 0$
- CC2: $x = 0.1$
- CC3: $x = 0.2$
- CC4: $x = 0.3$
- CC5: $x = 0.4$

### `GB_slope`: Geromont and Butterworth index slope

This MP adjusts TAC based on previous catch and the trend in a relative abundance index to aim for somewhat stable catch rates. The TAC is calculated as:

$$
\textrm{TAC}_y= C_{y-1}(1+\lambda I),
$$

where $C_{y-1}$ is catch from the previous year, $I$ is the slope of the linear regression of the log of an abundance index over the last 5 years, and $\lambda$ is a gain parameter the controls how quickly TAC is adjusted based on the slope of the index. The TAC is subject to the following conditions:

- if next TAC > 1.2 last catch, then TAC = 1.2 $\cdot$ catch
- if next TAC < 0.8 last catch, then TAC = 0.8 $\cdot$ last catch

These values limit the rate at which the TAC can be adjusted up or down.

See @geromont2015 for more information.

### `ICI`: Index confidence interval

This MP adjusts catch based on the value of the relative abundance index in the current year divided by the relative abundance index mean and standard error.

The TAC is calculated as:

$$
\textrm{TAC}_y= \alpha C_{y-1},
$$

where $C_{y-1}$ is the catch from the previous year, and $\alpha$ is defined as:

$$
\alpha =
\begin{cases}
d, & \textrm{if}\ I \lt CI_L \\
u, & \textrm{if}\ I \gt CI_H \\
1, & \textrm{if}\ CI_L \le I \le CI_H.
\end{cases}
$$

The symbol $I$ represents the index in the most recent year, $d$ is 0.75 for both ICI and ICI2, $u$ is 1.05 and 1.25 for ICI and ICI2 (respectively), and $CI_L$ and $CI_H$ are the lower and upper bound of the confidence interval of mean historical index. The confidence interval is calculated using Z-scores as follows:

- ICI: The catch is reduced by 0.75 if the Z-score of the current year's index is less than -0.44. The catch is increased by 1.05 if the Z-score of the current year's index is greater than 1.96. Otherwise, the catch is held constant.
- ICI2: This method is less precautionary of the two ICI MPs by allowing for a larger increase in TAC and a lower threshold of the index to decrease the TAC. The catch is reduced by 0.75 if the Z-score of the current year's index is less than -1.96. The catch is increased by 1.25 if the Z-score of the current year's index is greater than 1.96. Otherwise, the catch is held constant.

See @jardim2015 for more information.

### `Iratio`: Mean index ratio

The TAC is adjusted by the ratio $\alpha$, with the numerator being the mean index in the most recent two years of the time series and the denominator being the mean index in the three years prior to those in the numerator. This MP is the stochastic version of Method 3.2 used by ICES for Data-Limited Stocks [@ices2012].

The TAC is calculated as:

$$
\textrm{TAC}_y = \alpha C_{y-1},
$$

where $C_{y-1}$ is the catch from the previous year and $\alpha$ is the ratio of the mean index in the most recent two years of the time series and the mean index in 3--5 years before current time. The number of reference years can be adjusted. The parameter $\alpha$ is defined as:

$$
\alpha = \frac{\frac{I_{yr-1} + I_{yr-2}} {2}} {\frac{I_{yr-3} + I_{yr-4} + I_{yr-5}} {3}}.
$$

See @jardim2015 for more information.

### `Islope`: Index slope tracking

A management procedure that incrementally adjusts the TAC to maintain a constant relative abundance index. The TAC is calculated as:

$$
\textrm{TAC}_y = \textrm{TAC}^*(1+\lambda I),
$$

where $\textrm{TAC}^*$ is $(1-xx)$ multiplied by the mean catch from the past 5 years for the first projection year. In subsequent years, $\textrm{TAC}^*$ is simply the TAC from the previous year. $\lambda$ is a gain parameter, and $I$ is the slope of the log relative abundance index over the past $n$ years (default $n = 5$).

There are four variants of this procedure:

- Islope1: The least biologically precautionary, with $\lambda = 0.4$ and $xx = 0.2$
- Islope2: Increasingly biologically precautionary, with $\lambda = 0.4$ and $xx = 0.3$
- Islope3: Increasingly biologically precautionary, with  $\lambda = 0.4$ and $xx = 0.4$
- Islope4: The most biologically precautionary, with  $\lambda = 0.2$ and $xx = 0.2$

```{r mps-islope-demo, fig.cap="Illustration of Islope."}
f <- function(catch_mean_recent = 100, xx = 0.2, lambda = 0.4,
  slope = 0.2) {
  tac_star <- (1 - xx) * catch_mean_recent
  tac_star * (1 + lambda * slope)
}

pars <- expand.grid(
  catch_mean_recent = 100,
  xx = c(0),
  lambda = c(0.2, 0.4),
  slope = seq(-0.5, 0.5, length.out = 200)
)

pars$tac <- purrr::pmap_dbl(pars, f)

library(ggplot2)
library(dplyr)
pars %>%
  mutate(xx = paste("xx =", xx)) %>%
  # mutate(lambda = paste("lambda =", lambda)) %>%
  ggplot(aes(slope, tac, color = as.factor(lambda))) +
  geom_line() +
  facet_wrap(~ xx) +
  ggsidekick::theme_sleek() +
  labs(
    colour = expression(gamma),
    x = "Slope in ln(index)",
    y = "TAC (based on 100 last year)"
  ) +
  geom_hline(yintercept = 100, lty = 2) +
  scale_color_brewer(palette ="Set2")

# median(Islope_(1, DLMtool::SimulatedData, lambda = 0.4, xx = 0.2, reps = 1000L)$TAC)
#
# median(Islope_(1, DLMtool::SimulatedData, lambda = 0.4, xx = 0.2, reps = 1000L)$TACstar)
#
# median(Islope_(1, DLMtool::SimulatedData, lambda = 0.4, xx = 0.2, reps = 1000L)$TAC)
```

<!-- TODO: missing `SPmod` and potentially others -->

### `SBT1`: "Simple" management procedure

SBT1 is an MP that makes incremental adjustments to TAC recommendations based on the trend in relative abundance index levels. The TAC is calculated as:

$$
\textrm{TAC}_y =
\begin{cases}
C_{y-1} (1 - K_1 |\lambda|^\gamma) & \textrm{if}\ \lambda \lt 0 \\
C_{y-1} (1 + K_2 |\lambda|) & \textrm{if}\ \lambda \ge 0,
\end{cases}
$$

where $\lambda$ is the slope of the index over the last $n$ years (default $n = 5$), and $K_1$, $K_2$, and $\gamma$ are arguments to the MP. By default they are $K_1 = 1.5$, $K_2 = 3$, and $\gamma = 1$.

```{r mp-sbt1-demo, fig.cap="Illustration of SBT1."}
f <- function(c_y1, lambda, k1, k2, gamma) {
  if (lambda >= 0) tac <- c_y1 * (1 + k2 * abs(lambda))
  if (lambda < 0) tac <- c_y1 * (1 - k1 * abs(lambda)^gamma)
  if (tac < 0) tac <- 0
  tac
}

pars <- expand.grid(
  c_y1 = 100,
  lambda = seq(-0.5, 0.5, length.out = 200),
  k1 = c(1, 1.5, 3),
  k2 = c(1.5, 3, 5),
  gamma = c(0.5, 1, 1.5)
)

pars$tac <- purrr::pmap_dbl(pars, f)
pars %>%
  mutate(k1 = paste("K1 =", k1)) %>%
  mutate(k2 = paste("K2 =", k2)) %>%
  ggplot(aes(lambda, tac, colour = as.factor(gamma))) +
  geom_line() +
  facet_grid(k1 ~ k2) +
  ggsidekick::theme_sleek() +
  labs(
    colour = expression(gamma),
    x = expression(lambda ~ (Slope ~ "in" ~ index)),
    y = "TAC (based on 100 last year)"
  )+
  geom_hline(yintercept = 100, lty = 2) +
  scale_color_brewer(palette ="Set2")
# FIXME: why does SBT1 do lm(I_hist ~ ind)) not in log space! Units!?
```

### `IDX`: Index-based MP from Cox et al. (In press)

This MP was used in the Cox et al. (In press) rebuilding plan for outside Yelloweye Rockfish in BC. The MP assigns TAC based on:

$$
\textrm{TAC}_y =
\begin{cases}
\textrm{TAC}_\textrm{Floor}, & \textrm{if}\ \Delta I_y \leq \delta_\textrm{min} \\
(1 + \Delta I_y ) \textrm{TAC}_{y-1}, & \textrm{if}\ \delta_\textrm{min} \lt \Delta I_y \leq \delta_\textrm{max} \\
(1 + \delta_\textrm{max}) \textrm{TAC}_{y-1}, & \textrm{if}\ \Delta I_y \gt \delta_\textrm{max},
\end{cases}
$$

where $\delta_\textrm{min}$ is the most negative drop allowed in the relative biomass index before the fishery is closed that year (by default assuming $\textrm{TAC}_\textrm{Floor} = 0$). We set $\delta_\textrm{min} = -0.50$ as in TODO, but this could be tuned for individual stocks. The maximum increase in TAC is capped at $\delta_\textrm{max} = 0.25$ by default.

This MP can be additionally smoothed:

$$
\textrm{TAC}_y = \lambda \cdot \textrm{TAC}_y + (1-\lambda) \cdot \textrm{TAC}_{y-1},
$$

where $\lambda$ controls the degree of smoothing and can range between 0 and 1. TODO used $\lambda=0.5$. We define these MPs for DLMtool as `IDX` and `IDXsmooth`.

```{r mp-idx-demo, fig.cap="Illustration of SBT1."}
f <- function(tac_prev, tac_floor, delta_min, delta_max, delta_ind) {
  if (delta_ind <= delta_min) tac <- tac_floor
  if (delta_ind > delta_min && delta_ind <= delta_max)
    tac <- (1 + delta_ind) * tac_prev
  if (delta_ind > delta_max)
    tac <- (1 + delta_max) * tac_prev
  if (tac < 0) tac <- 0
  tac
}

pars <- expand.grid(
  tac_prev = 100,
  tac_floor = c(0, 10),
  delta_min = c(-0.5, -0.25),
  delta_max = c(0.2, 0.4),
  delta_ind = seq(-0.6, 0.6, length.out = 100)
)

pars$tac <- purrr::pmap_dbl(pars, f)
pars %>%
  mutate(delta_min = paste("delta_min =", delta_min)) %>%
  mutate(delta_max = paste("delta_max =", delta_max)) %>%
  # mutate(delta_ind = ifelse(tac_floor == 0, delta_ind, delta_ind + 0.01)) %>%
  ggplot(aes(delta_ind, tac, colour = as.factor(tac_floor))) +
  geom_line() +
  facet_grid(delta_min ~ delta_max) +
  ggsidekick::theme_sleek() +
  labs(
    colour = expression(TAC[Floor]),
    x = expression(Delta ~ I[y]),
    y = "TAC (based on 100 last year)"
  )+
  geom_hline(yintercept = 100, lty = 2) +
  scale_color_brewer(palette ="Set2")
# FIXME: why does SBT1 do lm(I_hist ~ ind)) not in log space! Units!?
```
