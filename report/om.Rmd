# OM

## Constructing the operating model

Let's combine the stock, fleet, observation, and implementation objects into a complete operating model:

For now I am going to pick out some measure procedures that look plausible for our data. The next step is to run our data through the data conversion function and run `DLMtool::can()`. FIXME

Available management procedures

```{r}
DLMtool::avail("MP")
```

```{r, results='asis'}
csasdown::csas_table(DLMtool::MPtype(DLMtool::avail('MP')))
```

```{r}
avail("Output")
avail("Reference")
```

```{r echo = TRUE}
om <- new('OM', stock, fleet, obs, imp)
mp <- c("DCAC", "DCAC_40", "DBSRA4010", "DBSRA", "DBSRA_40", 
  "DCAC4010", "AvC", "CC1", "CC2", "CC3", "CC4", "CC5", 
  "SPSRA", "SPMSY", "NFref", "FMSYref", "FMSYref50", "DD",
  "DD4010", "GB_CC")
mp <- sort(mp)
om@nsim <- 200L
```

```{r, results='asis'}
csasdown::csas_table(MPtype(mp))
```

There are a variety of built-in plotting functions to examine the components of the operating model:

We may want to develop our own plotting functions.

```{r, eval=TRUE, fig.asp=1}
oldpar <- par()
plotStock(om, nsamp = 3, incVB = TRUE)
```

```{r, eval=TRUE}
plotSelect(om, sim = 1) # one sample, others will look different
```

```{r, eval=TRUE, fig.asp=1}
plotFleet(fleet, Stock = stock)
```

```{r, eval=TRUE, fig.asp=1}
plotImp(imp)
```

```{r, eval=TRUE, fig.asp=0.8}
plotObs(obs)
```

Now we can run closed-loop simulation:

```{r, echo=FALSE, message=FALSE, warning=FALSE, cache=TRUE}
file_name <- here::here("generated-data", "shortracker-mse.rds")
if (!file.exists(file_name)) {
  DLMtool::setup(cpus = parallel::detectCores())
  short_mse <- runMSE(OM = om, MPs = mp, parallel = TRUE)
  saveRDS(short_mse, file = file_name)
} else {
  short_mse <- readRDS(file_name)
}
```

Check convergence:

```{r}
DLMtool::Converge(short_mse)
```

```{r}
summary(short_mse)
```

Illustrating the built-in plotting functions:

```{r}
Tplot(short_mse)
Tplot2(short_mse)
```


```{r}
wormplot(short_mse)
```

```{r}
Pplot(short_mse)
Pplot2(short_mse)
```

```{r}
Pplot2(short_mse, traj="quant", quants=c(0.2, 0.8))
```

```{r}
Kplot(short_mse)
```

```{r}
Cplot(short_mse)
```

And examine the output.

```{r}
# plot(short_mse)
# oldpar <- par()
##DFO_hist(short_mse)
par(mfrow = c(1, 1))
DFO_plot(short_mse)
# DFO_plot2(short_mse)
```

```{r, fig.asp=1, warning=FALSE}
DFO_proj(short_mse)
#DFO_hist(short_om)
# DFO_plot2(short_mse)

# d <- DFO_plot2(short_mse)
# ggplot(d, aes(B50/100, LTY/100, label = MPs, colour = Satisfice)) +
#   geom_vline(xintercept = 0.5, col = "grey50") +
#   geom_hline(yintercept = 0.5, col = "grey50") +
#   geom_text() + ggsidekick::theme_sleek() +
#   scale_colour_manual(values = c("grey60", "black")) +
#   guides(colour = FALSE) +
#   xlab(expression(Pr(B>0.5~B[MSY]))) +
#   ylab(expression(Pr(yield>0.5~yield~at~F[MSY]))) +
#   xlim(0, 1) + ylim(0, 1)
par(oldpar)
```

The following are some plots I was playing with a long time ago. We should wrap the useful ones into their own functions in our package.

```{r, fig.asp=1}
yend <- max(short_mse@proyears)
ffmsy <- short_mse@F_FMSY[,,yend]
bbmsy <- short_mse@B_BMSY[,,yend]

ffmsy <- reshape2::melt(ffmsy) %>%
  dplyr::rename(iter = Var1, mp = Var2, ffmsy = value)
bbmsy <- reshape2::melt(bbmsy) %>%
  dplyr::rename(iter = Var1, mp = Var2, bbmsy = value)

d <- dplyr::inner_join(ffmsy, bbmsy)

n <- data.frame(mp = 1:length(short_mse@MPs), mp_name = short_mse@MPs)
# n$mp_name <- paste(1:nrow(n), n$mp_name)

d <- dplyr::left_join(d, n)

library(ggplot2)
ggplot(dplyr::filter(d), aes(bbmsy, ffmsy)) +
  geom_vline(xintercept = c(0.4, 0.8), alpha = 0.2) +
  geom_hline(yintercept = 1, alpha = 0.2) +
  geom_density_2d(aes(colour = ..level..), bins = 5) +
  viridis::scale_colour_viridis() +
  ggsidekick::theme_sleek() +
  facet_wrap(~mp_name) +
  ylim(0, 3.5) + xlim(0, 3.5) +
  geom_point(alpha = 0.2) +
  labs(colour = "Prob. density", x = expression(B/B[MSY]),
    y = expression(F/F[MSY])) +
  guides(colour = FALSE)
#ggsave("analysis/short-bbmsy-ffmsy-multi.pdf", width = 8, height = 8)
```

```{r, fig.asp=1.9, out.width = "4.8in", fig.width=7}
library(dplyr)
library(RColorBrewer)
ffmsy <- short_mse@F_FMSY[,,] %>% reshape2::melt() %>%
  dplyr::rename(iter = Var1, mp = Var2, ffmsy = value, year = Var3)
bbmsy <- short_mse@B_BMSY[,,] %>% reshape2::melt() %>%
  dplyr::rename(iter = Var1, mp = Var2, bbmsy = value, year = Var3)
d <- dplyr::inner_join(ffmsy, bbmsy)
d <- dplyr::left_join(d, n)
d <- reshape2::melt(d, id.vars = c("iter", "mp", "year", "mp_name"))
levels(d$variable) <- c(expression(F/F[MSY]), expression(B/B[MSY]))

d_median <- d %>% group_by(mp_name, year, variable) %>%
  summarise(median_value = median(value)) %>%
  mutate(iter = NA)

fudge <- 3.5
d$over <- FALSE
d$over[d$value > fudge] <- TRUE
d$value[d$over] <- fudge
d_median$median_value[d_median$median_value > fudge] <- fudge

d_last <- dplyr::filter(d, year == max(year)) %>%
  select(-over, -year) %>%
  rename(last_value = value)
d <- inner_join(d, d_last)

cols <- brewer.pal(3, "RdBu")
cols[2] <- "grey80"

plot_timeseries <- function(dat, dat_median, title = "",
  ylim = c(0, fudge), cols, values, labels = TRUE, yaxis = TRUE) {
  g <- ggplot(dat, aes_string("year", "value", group = "iter")) +
    geom_line(aes_string(colour = "last_value"), alpha = 0.3) +
    facet_grid(mp_name~., labeller = label_parsed) +
    ggsidekick::theme_sleek() +
    scale_colour_gradientn(colours = cols,
      values = values) +
    geom_line(data = dat_median, aes_string("year", "median_value"),
      colour = "black", lwd = 1.5) +
    ylim(ylim[1], ylim[2]) +
    ggtitle(title) +
    guides(colour = FALSE) +
    ylab("Value") + xlab("Year")

  if (!labels)
    g <- g + theme(strip.background = element_blank(),
      strip.text.y = element_blank())

  if (!yaxis)
    g <- g + theme(axis.text.y = element_blank())
  g
}

cols <- brewer.pal(5, "RdBu")
cols <- c(cols[1], "grey50", cols[length(cols)])
set.seed(42)
# d_ <- filter(d, iter %in% sample(seq_len(max(d$iter)), 30))
d_ <- d

# plot_timeseries(d, d_median,
# cols = cols, values = scales::rescale(c(0, 0.8, 1.2, fudge)))

# mps <- c("DCAC", "DCAC_40")
# p1 <- plot_timeseries(filter(d_, variable == "B/B[MSY]", mp_name %in% mps),
#   filter(d_median, variable == "B/B[MSY]", mp_name %in% mps), expression(B/B[MSY]),
#   cols = cols, values = scales::rescale(c(0, 0.8, 1.2, fudge)),
#   labels = TRUE)
# p2 <- plot_timeseries(filter(d_, variable == "F/F[MSY]", mp_name %in% mps),
#   filter(d_median, variable == "F/F[MSY]", mp_name %in% mps), expression(F/F[MSY]),
#   cols = cols, values = scales::rescale(c(fudge, 1.2, 0.8, 0)),
#   labels = TRUE, yaxis = TRUE)
# gridExtra::grid.arrange(p1, p2, ncol = 2)

# pdf("analysis/short-bbmsy-ffmsy-ts-ex.pdf", width = 6, height = 3.5)
# gridExtra::grid.arrange(p1, p2, ncol = 2)
# dev.off()

# mps <- unique(d_$mp_name)
# # mps <- mps[-which(mps %in% c("CC4"))]
# p1 <- plot_timeseries(filter(d_, variable == "B/B[MSY]", mp_name %in% mps),
#   filter(d_median, variable == "B/B[MSY]", mp_name %in% mps), expression(B/B[MSY]),
#   cols = cols, values = scales::rescale(c(0, 0.8, 1.2, fudge)),
#   labels = TRUE)
# p2 <- plot_timeseries(filter(d_, variable == "F/F[MSY]", mp_name %in% mps),
#   filter(d_median, variable == "F/F[MSY]", mp_name %in% mps), expression(F/F[MSY]),
#   cols = cols, values = scales::rescale(c(fudge, 1.2, 0.8, 0)),
#   labels = TRUE, yaxis = TRUE)
# gridExtra::grid.arrange(p1, p2, ncol = 2)

# pdf("analysis/short-bbmsy-ffmsy-ts-ex-all.pdf", width = 6, height = 6)
# gridExtra::grid.arrange(p1, p2, ncol = 2)
# dev.off()

mps <- unique(d_$mp_name)
# mps <- mps[-which(mps %in% c("CC4"))]
p1 <- plot_timeseries(filter(d_, variable == "B/B[MSY]", mp_name %in% mps),
  filter(d_median, variable == "B/B[MSY]", mp_name %in% mps), expression(B/B[MSY]),
  cols = cols, values = scales::rescale(c(0, 0.8, 1.2, fudge)),
  labels = TRUE)
p2 <- plot_timeseries(filter(d_, variable == "F/F[MSY]", mp_name %in% mps),
  filter(d_median, variable == "F/F[MSY]", mp_name %in% mps), expression(F/F[MSY]),
  cols = cols, values = scales::rescale(c(fudge, 1.2, 0.8, 0)),
  labels = TRUE, yaxis = TRUE)
gridExtra::grid.arrange(p1, p2, ncol = 2)

# pdf("analysis/short-bbmsy-ffmsy-ts-ex-all.pdf", width = 6, height = 6)
# gridExtra::grid.arrange(p1, p2, ncol = 2)
# dev.off()

#########3
ffmsy <- short_mse@F_FMSY[,,] %>% reshape2::melt() %>%
  dplyr::rename(iter = Var1, mp = Var2, ffmsy = value, year = Var3)
bbmsy <- short_mse@B_BMSY[,,] %>% reshape2::melt() %>%
  dplyr::rename(iter = Var1, mp = Var2, bbmsy = value, year = Var3)
d <- dplyr::inner_join(ffmsy, bbmsy)
d <- dplyr::left_join(d, n)
d <- reshape2::melt(d, id.vars = c("iter", "mp", "year", "mp_name"))
levels(d$variable) <- c(expression(F/F[MSY]), expression(B/B[MSY]))

d_sum <- d %>% group_by(mp_name, year, variable) %>%
  summarise(median_value = median(value),
    l = quantile(value, probs = 0.75),
    u = quantile(value, probs = 0.25),
    ll = quantile(value, probs = 0.95),
    uu = quantile(value, probs = 0.05))


# d_sum$median_value[d_sum$median_value > fudge] <- fudge
# d_sum$u[d_sum$u > fudge] <- fudge
# d_sum$l[d_sum$l > fudge] <- fudge

d <- inner_join(d, d_last)

d$last_value[d$last_value > fudge] <- fudge
# d$value[d$value > fudge] <- fudge


cols <- brewer.pal(5, "RdBu")
cols <- c(cols[1], "grey50", cols[length(cols)])
g <- ggplot(d_sum, aes_string("year", "median_value")) +
  facet_grid(mp_name~variable, labeller = label_parsed) +
  geom_ribbon(aes(ymin = ll, ymax = uu), fill = "grey90") +
  geom_ribbon(aes(ymin = l, ymax = u), fill = "grey70") +
  ggsidekick::theme_sleek() +
  geom_line(lwd = 1.5) +
  coord_cartesian(ylim = c(0, 4)) +
  guides(colour = FALSE) +
  xlim(25, 50) +
  geom_hline(yintercept = 1,
    col = "black", lty = 2) +
  ylab("Value") + xlab("Year")
  # geom_line(data = filter(d, iter %in% c(1:10)),
  #   aes(y = value, group = iter),
  #   alpha = 0.4, colour = "blue")
  # scale_colour_gradientn(colours = cols,
  #     values = c(0, 0.8, 1.2, 3))
  # viridis::scale_colour_viridis()
g
```

```{r, fig.asp=1.2}
voi_out <- DLMtool::VOI(short_mse)
```

