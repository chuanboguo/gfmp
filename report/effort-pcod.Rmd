`r if(knitr:::is_latex_output()) '\\Appendices'`

`r if(!knitr:::is_latex_output()) '# (APPENDIX) Appendix {-}'`

# EXPLORING CATCH AND EFFORT TIMESERIES FOR PACIFIC COD

This appendix has three purposes:

1. Derive a consistent measure of (bottom trawl) commercial fishing effort that is relevant to Pacific Cod. To do this we will look at effort for depths and localities that have the highest proportion of Pacific Cod catches. 

2. Bring in code from 2018 assessment to run standardized catch per unit effort index.

The effort times will be used to parameterize the operating model. The catch time series will be used as part of checking the calibration of the operating model. The catch timeseries and CPUE timeseries may be used when applying a management procedure to the observed data.

## EFFORT

```{r effort-get-data-pc}
.f <- here::here("report/data/cpue-historical-pcod.rds")
if (!file.exists(.f)) {
  dat_historicalpc <- gfplot::get_cpue_historical(species = NULL, end_year = 2018)
  saveRDS(dat_historicalpc, file = .f)
} else {
  dat_historicalpc <- readRDS(.f)
}
```

```{r effort-load-packages-pc, warning=FALSE, message=FALSE, echo=FALSE}
library(dplyr)
library(ggplot2)
```

```{r effort-plot-raw-data-pc}
dat_historicalpc %>% 
  group_by(year) %>% 
  summarize(effort = sum(hours_fished )) %>% 
  ggplot(aes(year, effort)) + 
  geom_line()
```

<!-- We will process the data the way we have before. This tidies the data so that we can work with it and puts the depths into bins. -->

```{r effort-tidy-data-pc}
datpc <- gfplot::tidy_cpue_historical(dat_historicalpc,
  species_common = "pacific cod",
  use_alt_year = FALSE,
  year_range = range(dat_historicalpc$year),
  depth_band_width = 25,
  area_grep_pattern = "^5A|^5B|^5C|^5D",
  depth_bin_quantiles = c(0, 1),
  min_bin_prop = 0,
  type = "trip-level-data")
```

Let's look at the distribution of trips by depth by year in terms of which trips caught Pacific Cod:

```{r effort-depth-distribution-pc}
gpc <- datpc %>%
  mutate(time_bin = seq(1930, 2020, 5)[findInterval(year, vec = seq(1930, 2020, 5))]) %>% 
  mutate(`Trip\ncaught this species` = 
      ifelse(pos_catch == 1, "Yes", "No")) %>%
  filter(best_depth < 1200) %>% 
  ggplot(aes(best_depth, fill = `Trip\ncaught this species`)) +
  geom_histogram(binwidth = 25) +
  ylim(0, NA) +
  coord_cartesian(expand = FALSE)
gpc

gpc + facet_wrap(~time_bin)
```

Pacific Cod are usually caught in fairly shallow waters---usually shallower than around 300m. 

We can look at a bubble plot of positive trips by year and locality. We will only show localities with at least 10 positive trips. The outside circle represents the number of trips. The inside coloured circle represents the number of trips that that reported catching at least Pacific Cod. 

```{r effort-locality-bubble-plot-pc}
datpc %>% group_by(locality) %>% 
  mutate(total_positive_trips = sum(pos_catch)) %>% 
  filter(total_positive_trips > 10) %>% 
  gfplot:::plot_predictor_bubbles("locality",
    group = "trip_id") %>% print()
```

**PLACEHOLDER TEXT** There are a number of localities in which Pacific Cod positive trips make up a much higher proportion of the total trips each year after 1996. This may suggest that they were systematically underreported prior to 1996 and we therefore may be missing a large portion of the effort prior to 1996. We should account for that scenario when parameterize in our operating models.

Let's look at the effort for the localities and depths that make up 80% of the shortraker rockfish catch. 

```{r effort-find-major-localities-and-depths-pc}
locality_keeppc <- datpc %>% group_by(locality) %>%
  summarize(locality_shortraker_catch = sum(spp_catch)) %>% 
  arrange(-locality_shortraker_catch) %>% 
  mutate(cumulative_catch = cumsum(locality_shortraker_catch)/
      sum(locality_shortraker_catch)) %>% 
  arrange(cumulative_catch) %>% 
  filter(cumulative_catch > 0) %>% 
  filter(cumulative_catch < 0.8)

depth_keeppc <- datpc %>%
  group_by(depth) %>% 
  summarize(depth_shortraker_catch = sum(spp_catch)) %>% 
  mutate(depth = as.numeric(as.character(depth))) %>% 
  arrange(-depth) %>% 
  mutate(cumulative_catch = cumsum(depth_shortraker_catch)/
      sum(depth_shortraker_catch)) %>%
  filter(cumulative_catch > 0) %>% 
  arrange(-depth) %>% 
  filter(cumulative_catch < 0.8)
```

```{r effort-locality-and-depth-tables-pc}
csasdown::csas_table(locality_keeppc, digits = c(0, 0, 2))
csasdown::csas_table(depth_keeppc, digits = c(0, 0, 2))
```

```{r effort-pull-pc}
depth_keeppc <- depth_keeppc %>% pull(depth)
locality_keeppc <- locality_keeppc %>% pull(locality)
```

Let's define a relevant "fleet" based on trips that are recorded at our filtered "prime Pacific Cod" depths and localities and look at the distribution of trips that did and did not catch Pacific Cod in our filtered data set:

```{r effort-histogram-relevant-fleet-pc}
dat_keeppc <- filter(datpc, best_depth > min(depth_keeppc) & locality %in% locality_keeppc)
dat_keeppc %>%
  mutate(time_bin = seq(1930, 2020, 5)[findInterval(year, vec = seq(1930, 2020, 5))]) %>% 
  mutate(`Trip\ncaught this species` = 
      ifelse(pos_catch == 1, "Yes", "No")) %>%
  filter(best_depth < 1200) %>% 
  ggplot(aes(best_depth, fill = `Trip\ncaught this species`)) +
  geom_histogram(binwidth = 25) +
  ylim(0, NA) +
  coord_cartesian(expand = FALSE)
```

Defined as we have here, our "feet" represents approximately `r round(sum(dat_keeppc$spp_catch) / sum(datpc$spp_catch) * 100, 0)`% of the total Pacific Cod catch in our databases from `r min(datpc$year)` to `r max(datpc$year)`.

Finally, we can look at the effort trajectory from our filtered data set:

```{r effort-basic-ts-pc}
dat_keeppc %>% 
  group_by(year) %>% 
  summarize(hours_fished = sum(hours_fished)) %>% 
  ggplot(aes(year, hours_fished)) + 
  geom_line()
```

```{r effort-save-csv-pc}
dat_keeppc %>% 
  group_by(year) %>% 
  summarize(hours_fished = sum(hours_fished)) %>% 
  readr::write_csv(path = here::here("report/data/pcod-fleet-effort.csv"))
```


```{r effort-basic-ts-catch-pc}
dat_keeppc %>%
  # filter(best_depth <= 800, year >= 1970) %>% 
  group_by(year) %>% 
  summarize(spp_catch = sum(spp_catch)) %>% 
  ggplot(aes(year, spp_catch)) + 
  geom_line()
```

We can also try jackknifing out individual localities to look at the sensitivity to any individual locality:

```{r effort-locality-sensitivity-pc}
get_effortpc <- function(excluded_locality) {
  dat_keeppc %>%
    filter(locality != excluded_locality) %>% 
    group_by(year) %>% 
    summarize(hours_fished = sum(hours_fished), excluded_locality = excluded_locality)
}
purrr::map_df(unique(dat_keeppc$locality), ~get_effortpc(.x)) %>% 
  ggplot(aes(year, hours_fished, colour = excluded_locality)) + 
  geom_line() +
  guides(colour = FALSE)
```

The timeseries of effort does not seem too sensitive to any one locality.  *NOTE: Maybe the cyan series (recent years) and the blue series (early years)*

How sensitive is the effort timeseries to our definition of common depths for Pacific Cod assuming we work with these same localities?

```{r effort-depth-sensitivity-pc}
get_effortpc <- function(depth_threshold) {
  filter(datpc, best_depth > depth_threshold & locality %in% locality_keeppc) %>% 
    group_by(year) %>% 
    summarize(hours_fished = sum(hours_fished), depth_threshold = depth_threshold)
}
g <- purrr::map_df(seq(150, 800, 50), ~get_effortpc(.x)) %>%
  ggplot(aes(year, hours_fished, 
    group = as.factor(depth_threshold), colour = depth_threshold)) + 
  geom_line() +
  scale_color_viridis_c()
g

# g + scale_y_continuous(trans = "sqrt")
```

**This is Placeholder text for shortraker* 

The depth threshold does affect the perceived ramp-up in effort to 1996, but it does not have a big effect on the perceived effort timeseries after 1996. This can help us bound our operating models. There is certainly some omitted effort prior to 1996. FIXME: Need to discuss with industry ballpark how much may be missing and whether this is changing over time. FIXME: Also how much foreign effort might be missed here.

Perhaps we can parameterize an operating model with slowly increasing effort until around 1990, effort that increases approximately 3-fold from around 1990 to 1995 before declining to approximately the same level at 2000 and remaining relatively constant since. In the operating model, the effort prior to 1990 may need to be increased by some multiplier with a fair bit of uncertainty.

```{r, eval=FALSE, include=FALSE}
library(glmmTMB)

dpc <- filter(dat_keeppc, year >= 1996, best_depth <= 500) #RF Changed best depth to <= 600 (using 800 broke model)
dpc$month <- as.numeric(dpc$month)
dpc$locality <- as.character(dpc$locality)
mean_best_depth <- mean(dpc$best_depth)
dpc$depth_scaled <- dpc$best_depth - mean_best_depth
m1pc <- glmmTMB(
  spp_catch ~ 1 + month + I(month^2) + I(month^3) + 
    depth_scaled + I(depth_scaled^2) + as.factor(locality) + 
    depth_scaled * as.factor(locality) +
    I(depth_scaled^2) * as.factor(locality) +
    hours_fished * as.factor(locality) +
    hours_fished + I(hours_fished^2), 
  data = dpc, family = tweedie(link = "log"),
  control = glmmTMBControl(
    optCtrl = list(iter.max = 2000, eval.max = 2000),
    profile = TRUE, collect = FALSE),
  verbose = TRUE)

dpc$pred_spp_catch <- predict(m1pc, type = "response")
dpc %>% mutate(after_1995 = year > 1995) %>%
  ggplot(aes(log(pred_spp_catch + 1), log(spp_catch + 1))) + geom_point() + 
  facet_wrap(~after_1995) +
  geom_abline(intercept = 0, slope = 1)
cor(dpc$pred_spp_catch, dpc$spp_catch) ^ 2


# d_old <- filter(dat_keep, year < 1996, best_depth <= 800, year >= 1970)
d_oldpc <- filter(dat_keeppc, best_depth <= 500, year >= 1970)
d_oldpc$month <- as.numeric(d_oldpc$month)
d_oldpc$locality <- as.character(d_oldpc$locality)
d_oldpc <- filter(d_oldpc, locality %in% dpc$locality)
d_oldpc$depth_scaled <- d_oldpc$best_depth - mean_best_depth

d_oldpc$spp_catch_pred <- predict(m1pc, newdata = d_oldpc, type = "response")

get_tweedie_mean <- function(y) {
  # message(length(y))
  # mm <- glmmTMB(y ~ 1, family = tweedie(link = "log"),
  #   control = glmmTMBControl(
  #   optCtrl = list(iter.max = 2000, eval.max = 2000),
  #   profile = TRUE, collect = FALSE))
  # browser()
  # fixef(mm)[[1]][[1]]
  mean(y)
}

d_oldpc %>% group_by(year) %>%
  summarise(
    spp_catch_pred = sum(spp_catch_pred), 
    # sd_spp_catch = sd(log(spp_catch_pred)),
    spp_catch = sum(spp_catch)) %>% 
  ggplot(aes(
    x = year, 
    y = spp_catch_pred, 
    ymin = spp_catch_pred, 
    ymax = spp_catch_pred)) + geom_line() +
  geom_ribbon(alpha = 0.4) +
  geom_vline(xintercept = 1996, lty = 2) +
  scale_y_continuous(trans = "sqrt") +
  geom_line(aes(y = spp_catch), lty = 2)
```

## HISTORICAL CATCH RECONSTRUCTION

Here we will fit a model that predicts trawl catch based on hours fished, depth, locality, and month with the modern data and then try to predict the historical data with those same covariates. This represents the catch you would expect if abundance was relatively constant and those variables largely capture changes in fishing behaviour. This is not meant to represent the truth but an exploration of what you would expect under those assumptions. This may give some indication of how much under- or over-reporting there was at various points in time in the past.

To do this we will fit a Gradient Boosting Machine (GBM) machine learning model. This, or a similar machine learning model, is likely to give us the best predictive power based on our covariates without assuming any parametric relationship between the covariates and of the response. We will use the caret R package to perform 10-fold cross validation to evaluate what tuning parameters in our model give us the best out-of-sample productive performance.

FIXME: Give more details if we actually use this.

Here are the cross validation results for a number of tuning parameters first for the positive catch model and second for the catch vs. no catch model:

```{r effort-gbm-catch-train-pc, warning=FALSE, message=FALSE, eval=TRUE, results='hide'}
library(gbm)

.d <- filter(dat_keeppc, best_depth <= 500, year > 1975)
.d$month <- as.numeric(.d$month)
.d$locality <- as.factor(as.character(.d$locality))
d_modernpc <- filter(.d, year >= 1996)

d_pos_modernpc <- filter(d_modernpc, spp_catch > 0)

library(caret)
library(doParallel)
doParallel::registerDoParallel(parallel::detectCores())
.grid <- expand.grid(shrinkage = c(0.01), interaction.depth = 1:4, 
  n.trees = c(100, 500, 1000, 2000), n.minobsinnode = 10)
ctrl <- trainControl(method = "repeatedcv",
  repeats = 1, number = 10)
mmpc <- caret::train(log(spp_catch) ~
    month + best_depth + locality + hours_fished, 
  data = d_pos_modernpc, method = "gbm", tuneGrid = .grid, trControl = ctrl)
plot(mmpc)

d_modernpc$pos_catch <- as.factor(d_modernpc$pos_catch)
mm_binpc <- caret::train(pos_catch ~
    month + best_depth + locality + hours_fished, 
  data = d_modernpc, method = "gbm", tuneGrid = .grid, trControl = ctrl)
plot(mm_binpc)
# mm_bin$bestTune
```


```{r effort-gbm-fit-pc}
NTREES <- 2000
INT_DEPTH <- 4
SHRINK <- 0.01
m_pospc <- gbm(log(spp_catch) ~
    month + best_depth + locality + hours_fished, 
  data = d_pos_modernpc, distribution = "gaussian", 
  n.trees = NTREES, interaction.depth = INT_DEPTH, shrinkage = SHRINK)
#d_modernpc$pos_catch <- as.integer(d_modernpc$pos_catch) - 1  #RF WHY IS THIS LINE HERE?
m_binpc <- gbm(pos_catch ~
    month + best_depth + locality + hours_fished, data = d_modernpc,
  distribution = "bernoulli", n.trees = NTREES, interaction.depth = INT_DEPTH,
  shrinkage = SHRINK)
d_modernpc$pred_spp_catch_pos <- 
  exp(predict(m_pospc, type = "response", n.trees = NTREES, newdata = d_modernpc))
d_modernpc$pred_spp_catch_bin <- predict(m_binpc, type = "response", n.trees = NTREES)
d_modernpc$pred_spp_catch <- d_modernpc$pred_spp_catch_bin *
  d_modernpc$pred_spp_catch_pos
# cor(d_modern$pred_spp_catch, d_modern$spp_catch) ^ 2
```

We can look at the marginal effects of the various predictors and the marginal effects of interactions between various predictors. First, these are the effects from the positive catch model:

```{r effort-plot-gbm-positive-pc}
plot(m_pospc, i.var = c(2))
plot(m_pospc, i.var = c(1))
plot(m_pospc, i.var = c(1, 2))
plot(m_pospc, i.var = c(2, 3))
plot(m_pospc, i.var = c(1, 3))
plot(m_pospc, i.var = c(2, 4))
plot(m_pospc, i.var = c(3, 4))
```

These are the marginal effects from the binary model (shortraker catch vs. no shortraker catch):

```{r effort-plot-gbm-binary-pc}
plot(m_binpc, i.var = c(2))
plot(m_binpc, i.var = c(1))
#plot(m_binpc, i.var = c(1, 2))
plot(m_binpc, i.var = c(2, 3))
plot(m_binpc, i.var = c(1, 3))
#plot(m_binpc, i.var = c(2, 4))
plot(m_binpc, i.var = c(3, 4))
```



## COMMERCIAL CATCH PER UNIT EFFORT

Previously we have always conducted catch per unit effort analyses separately for the historical and modern time periods. Since it's important to try to figure out (very approximately) what has been happening over the entire timeseries for the purposes of parameterizing our operating model, here I will try to combine the two. Because there is not sufficient data in each depth bin for each year we will work with a quadratic function for depth instead of the binned factor predictors that has been used in similar analyses at PBS in the past. The form of our model (in a quick draft R format) is:

```
cpue = Tweedie(mu, phi, power),
mu ~ exp(0 + year_factor + month + depth_scaled + I(depth_scaled^2) + 
  (1 | locality) + (1 | year_locality)).
```

```{r effort-fit-cpue-pc, warning=FALSE}
dpc <- filter(dat_keeppc, year >= 1978, best_depth <= 800)
dpc$year_locality <- paste0(dpc$year, dpc$locality)
dpc$depth <- as.factor(dpc$depth)
dpc$month <- as.factor(dpc$month)
dpc$locality <- as.factor(dpc$locality)
dpc$year_locality <- as.factor(dpc$year_locality)
dpc$year_factor <- as.factor(dpc$year_factor)
dpc$depth_scaled <- dpc$best_depth - mean(dpc$best_depth)

dpc <- left_join(dpc, select(.d, year, area, trip_id, locality))

dpc %>% group_by(year) %>%
  summarise(
    effort = sum(hours_fished),
    catch_observed = sum(spp_catch)
    ) %>%
  select(year, catch_observed) %>% 
  reshape2::melt(id.vars = "year", variable.name = "Type") %>% 
  ggplot(aes(year, value, colour = Type)) + geom_line()

dpc %>% group_by(year) %>%
  summarise(effort = sum(hours_fished)) %>%
  ggplot(aes(year, effort)) + geom_line()


```



```{r effort-plot-cpue-uncorrected-pc}
m <- gfplot::fit_cpue_index_glmmtmb(dpc,
  cpue ~ 0 + year_factor + month + depth_scaled + I(depth_scaled^2) + 
    (1 | locality) + (1 | year_locality), verbose = FALSE)

gfplot::predict_cpue_index_tweedie(m) %>%
  ggplot(aes(year, est, ymin = lwr, ymax = upr)) + 
  geom_ribbon(alpha = .5) + 
  geom_line() +
  geom_vline(xintercept = 1996, lty = 2)
```


