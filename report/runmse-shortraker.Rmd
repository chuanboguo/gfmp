\newpage

# SHORTRAKER ROCKFISH: RESULTS

## Constructing the operating model

First, let's combine the stock, fleet, observation, and mp objects into a complete operating model:


```{r}
# avail("Output")
# avail("Reference")
```

```{r echo = TRUE}
om <- new('OM', stock, fleet, obs, imp)

om@nsim <- 250L
```

There are a variety of built-in plotting functions to examine the components of the operating model:

We may want to develop our own plotting functions.

What are the essential plots to show?

* M as a distribution (and a timeseries if we were letting it change through time)
* vonB curves (this takes care of linf, K, t0 parameters)

Debatably these are already indicated by the filling of the slots before.

Selection and retention curves are a bit more important perhaps to visualize other slots translate into a shape.

Only need to show for one year unless there are time varying effects.


```{r, eval=TRUE, fig.asp=1, eval=FALSE}
pdf(here::here("report/ignore.pdf"))
x <- plotStock(om, nsamp = 5)
dev.off()

nsamp <- 3
nsim <- length(x$M)
its <- sample(seq_len(nsim), nsamp)
x$Marray
x$M_ageArray
x$Len_age
x$Wt_age
```

```{r, eval=TRUE}
plotSelect(om, sim = 1) # one sample, others will look different
```

```{r, eval=TRUE, fig.asp=1}
plotFleet(fleet, Stock = stock)
```

```{r, eval=TRUE, fig.asp=1}
plotImp(imp)
```

```{r, eval=TRUE, fig.asp=0.8}
plotObs(obs)
```

One thing we can do to check our operating model calibration is checksum random samples from the historical simulation against our observed data. For example, here are 11 samples from the simulated historical catch timeseries compared to the observed (reconstructed/corrected) catch timeseries.

```{r, fig.asp=0.8}
# DLMtool::setup(cpus = parallel::detectCores())
om@nsim <- 30
short_historical <- runMSE(om, Hist = TRUE, parallel = FALSE)
om@nsim <- 250L

# names(short_historical@TSdata)
# dim(short_historical@TSdata$Catch)

real_catch <- read.csv(here::here("report/data/shortraker-corrected-catch.csv"))
real_catch <- mutate(real_catch, synthetic = ifelse(Year >= 1990 & Year <= 1995, Predicted.catch, Observed.catch))

all_years <- data.frame(Year = (2018 - fleet@nyears):2018)
real_catch <- dplyr::left_join(all_years, real_catch)

set.seed(1567)
catch <- short_historical@TSdata$Catch %>%
  reshape2::melt() %>%
  dplyr::filter(Var1 %in% sample(unique(Var1), size = 11)) %>%
  transmute(sample_id = Var1, year = Var2 + min(real_catch$Year) - 1,
    catch = value, type = "Simulated") %>%
  bind_rows(data.frame(sample_id = 0, year = real_catch$Year,
    catch = real_catch$synthetic, type = "Observed", stringsAsFactors = FALSE))

catch %>%
  filter(!is.na(catch)) %>%
  group_by(sample_id) %>%
  mutate(catch = catch/max(catch)) %>%
  ggplot(aes(year, catch, colour = type)) +
  geom_line() +
  facet_wrap(~sample_id) +
  ylab("Historical catch") +
  xlab("Year")

short_historical@TSdata$B %>%
  reshape2::melt() %>%
  dplyr::filter(Var1 %in% sample(unique(Var1), size = 12)) %>%
  ggplot(aes(Var2, value)) +
  geom_line() +
  facet_wrap(~Var1, scales = "free_y") +
  ylab("Simulated historical biomass") +
  xlab("Year")

# short_data <- pbs2dlm::create_dlm_data(d)
# DLMtool::Turing(OM = om, Data = short_data, wait = FALSE)
```

Now we can run closed-loop simulation:

```{r, echo=FALSE, message=FALSE, warning=FALSE, cache=TRUE}
file_name <- here::here("generated-data", "shortraker-mse.rds")
if (!file.exists(file_name)) {
  DLMtool::setup(cpus = parallel::detectCores())
  short_mse <- runMSE(OM = om, MPs = mp, parallel = FALSE)
  saveRDS(short_mse, file = file_name)
} else {
  short_mse <- readRDS(file_name)
}
```

Check convergence:

```{r}
DLMtool::Converge(short_mse)
```

```{r}
summary(short_mse)
```

Illustrating the built-in plotting functions:

```{r}
Tplot(short_mse)
Tplot2(short_mse)
```


```{r}
wormplot(short_mse)
```

```{r}
Pplot(short_mse)
Pplot2(short_mse)
```

```{r}
Pplot2(short_mse, traj="quant", quants=c(0.2, 0.8))
```

```{r}
Kplot(short_mse)
```

```{r}
Cplot(short_mse)
```

And examine the output.

```{r}
# plot(short_mse)
# oldpar <- par()
##DFO_hist(short_mse)
par(mfrow = c(1, 1))
DFO_plot(short_mse)
# DFO_plot2(short_mse)
```

```{r, fig.asp=1, warning=FALSE}
DFO_proj(short_mse)
#DFO_hist(short_om)
# DFO_plot2(short_mse)

# d <- DFO_plot2(short_mse)
# ggplot(d, aes(B50/100, LTY/100, label = MPs, colour = Satisfice)) +
#   geom_vline(xintercept = 0.5, col = "grey50") +
#   geom_hline(yintercept = 0.5, col = "grey50") +
#   geom_text() + ggsidekick::theme_sleek() +
#   scale_colour_manual(values = c("grey60", "black")) +
#   guides(colour = FALSE) +
#   xlab(expression(Pr(B>0.5~B[MSY]))) +
#   ylab(expression(Pr(yield>0.5~yield~at~F[MSY]))) +
#   xlim(0, 1) + ylim(0, 1)
par(oldpar)
```

The following are some plots I was playing with a long time ago. We should wrap the useful ones into their own functions in our package.

```{r, fig.asp=1}
yend <- max(short_mse@proyears)
ffmsy <- short_mse@F_FMSY[,,yend]
bbmsy <- short_mse@B_BMSY[,,yend]

ffmsy <- reshape2::melt(ffmsy) %>%
  dplyr::rename(iter = Var1, mp = Var2, ffmsy = value)
bbmsy <- reshape2::melt(bbmsy) %>%
  dplyr::rename(iter = Var1, mp = Var2, bbmsy = value)

d <- dplyr::inner_join(ffmsy, bbmsy)

n <- data.frame(mp = seq_along(short_mse@MPs), mp_name = short_mse@MPs)
# n$mp_name <- paste(1:nrow(n), n$mp_name)

d <- dplyr::left_join(d, n)

library(ggplot2)
ggplot(dplyr::filter(d, !mp_name %in% c("NFref")), aes(bbmsy, ffmsy)) +
  geom_vline(xintercept = c(0.4, 0.8), alpha = 0.2) +
  geom_hline(yintercept = 1, alpha = 0.2) +
  geom_density_2d(aes(colour = ..level..), bins = 5) +
  viridis::scale_colour_viridis() +
  ggsidekick::theme_sleek() +
  facet_wrap(~mp_name) +
  ylim(0, 3.5) + xlim(0, 3.5) +
  geom_point(alpha = 0.2) +
  labs(colour = "Prob. density", x = expression(B/B[MSY]),
    y = expression(F/F[MSY])) +
  guides(colour = FALSE)
#ggsave("analysis/short-bbmsy-ffmsy-multi.pdf", width = 8, height = 8)
```

```{r, fig.asp=1.9, out.width = "4.8in", fig.width=7}
library(dplyr)
library(RColorBrewer)
ffmsy <- short_mse@F_FMSY[,,] %>% reshape2::melt() %>%
  dplyr::rename(iter = Var1, mp = Var2, ffmsy = value, year = Var3)
bbmsy <- short_mse@B_BMSY[,,] %>% reshape2::melt() %>%
  dplyr::rename(iter = Var1, mp = Var2, bbmsy = value, year = Var3)
d <- dplyr::inner_join(ffmsy, bbmsy)
d <- dplyr::left_join(d, n)
d <- reshape2::melt(d, id.vars = c("iter", "mp", "year", "mp_name"))
levels(d$variable) <- c(expression(F/F[MSY]), expression(B/B[MSY]))

d_median <- d %>% group_by(mp_name, year, variable) %>%
  summarise(median_value = median(value)) %>%
  mutate(iter = NA)

fudge <- 3.5
d$over <- FALSE
d$over[d$value > fudge] <- TRUE
d$value[d$over] <- fudge
d_median$median_value[d_median$median_value > fudge] <- fudge

d_last <- dplyr::filter(d, year == max(year)) %>%
  select(-over, -year) %>%
  rename(last_value = value)
d <- inner_join(d, d_last)

cols <- brewer.pal(3, "RdBu")
cols[2] <- "grey80"

plot_timeseries <- function(dat, dat_median, title = "",
  ylim = c(0, fudge), cols, values, labels = TRUE, yaxis = TRUE) {
  g <- ggplot(dat, aes_string("year", "value", group = "iter")) +
    geom_line(aes_string(colour = "last_value"), alpha = 0.3) +
    facet_grid(mp_name~., labeller = label_parsed) +
    ggsidekick::theme_sleek() +
    scale_colour_gradientn(colours = cols,
      values = values) +
    geom_line(data = dat_median, aes_string("year", "median_value"),
      colour = "black", lwd = 1.5) +
    ylim(ylim[1], ylim[2]) +
    ggtitle(title) +
    guides(colour = FALSE) +
    ylab("Value") + xlab("Year")

  if (!labels)
    g <- g + theme(strip.background = element_blank(),
      strip.text.y = element_blank())

  if (!yaxis)
    g <- g + theme(axis.text.y = element_blank())
  g
}

cols <- brewer.pal(5, "RdBu")
cols <- c(cols[1], "grey50", cols[length(cols)])
set.seed(42)
# d_ <- filter(d, iter %in% sample(seq_len(max(d$iter)), 30))
d_ <- d

# plot_timeseries(d, d_median,
# cols = cols, values = scales::rescale(c(0, 0.8, 1.2, fudge)))

# mps <- c("DCAC", "DCAC_40")
# p1 <- plot_timeseries(filter(d_, variable == "B/B[MSY]", mp_name %in% mps),
#   filter(d_median, variable == "B/B[MSY]", mp_name %in% mps), expression(B/B[MSY]),
#   cols = cols, values = scales::rescale(c(0, 0.8, 1.2, fudge)),
#   labels = TRUE)
# p2 <- plot_timeseries(filter(d_, variable == "F/F[MSY]", mp_name %in% mps),
#   filter(d_median, variable == "F/F[MSY]", mp_name %in% mps), expression(F/F[MSY]),
#   cols = cols, values = scales::rescale(c(fudge, 1.2, 0.8, 0)),
#   labels = TRUE, yaxis = TRUE)
# gridExtra::grid.arrange(p1, p2, ncol = 2)

# pdf("analysis/short-bbmsy-ffmsy-ts-ex.pdf", width = 6, height = 3.5)
# gridExtra::grid.arrange(p1, p2, ncol = 2)
# dev.off()

# mps <- unique(d_$mp_name)
# # mps <- mps[-which(mps %in% c("CC4"))]
# p1 <- plot_timeseries(filter(d_, variable == "B/B[MSY]", mp_name %in% mps),
#   filter(d_median, variable == "B/B[MSY]", mp_name %in% mps), expression(B/B[MSY]),
#   cols = cols, values = scales::rescale(c(0, 0.8, 1.2, fudge)),
#   labels = TRUE)
# p2 <- plot_timeseries(filter(d_, variable == "F/F[MSY]", mp_name %in% mps),
#   filter(d_median, variable == "F/F[MSY]", mp_name %in% mps), expression(F/F[MSY]),
#   cols = cols, values = scales::rescale(c(fudge, 1.2, 0.8, 0)),
#   labels = TRUE, yaxis = TRUE)
# gridExtra::grid.arrange(p1, p2, ncol = 2)

# pdf("analysis/short-bbmsy-ffmsy-ts-ex-all.pdf", width = 6, height = 6)
# gridExtra::grid.arrange(p1, p2, ncol = 2)
# dev.off()

mps <- unique(d_$mp_name)
# mps <- mps[-which(mps %in% c("CC4"))]
p1 <- plot_timeseries(filter(d_, variable == "B/B[MSY]", mp_name %in% mps),
  filter(d_median, variable == "B/B[MSY]", mp_name %in% mps), expression(B/B[MSY]),
  cols = cols, values = scales::rescale(c(0, 0.8, 1.2, fudge)),
  labels = TRUE)
p2 <- plot_timeseries(filter(d_, variable == "F/F[MSY]", mp_name %in% mps),
  filter(d_median, variable == "F/F[MSY]", mp_name %in% mps), expression(F/F[MSY]),
  cols = cols, values = scales::rescale(c(fudge, 1.2, 0.8, 0)),
  labels = TRUE, yaxis = TRUE)
gridExtra::grid.arrange(p1, p2, ncol = 2)

# pdf("analysis/short-bbmsy-ffmsy-ts-ex-all.pdf", width = 6, height = 6)
# gridExtra::grid.arrange(p1, p2, ncol = 2)
# dev.off()

#########3
ffmsy <- short_mse@F_FMSY[,,] %>% reshape2::melt() %>%
  dplyr::rename(iter = Var1, mp = Var2, ffmsy = value, year = Var3)
bbmsy <- short_mse@B_BMSY[,,] %>% reshape2::melt() %>%
  dplyr::rename(iter = Var1, mp = Var2, bbmsy = value, year = Var3)
d <- dplyr::inner_join(ffmsy, bbmsy)
d <- dplyr::left_join(d, n)
d <- reshape2::melt(d, id.vars = c("iter", "mp", "year", "mp_name"))
levels(d$variable) <- c(expression(F/F[MSY]), expression(B/B[MSY]))

d_sum <- d %>% group_by(mp_name, year, variable) %>%
  summarise(median_value = median(value),
    l = quantile(value, probs = 0.75),
    u = quantile(value, probs = 0.25),
    ll = quantile(value, probs = 0.95),
    uu = quantile(value, probs = 0.05))


# d_sum$median_value[d_sum$median_value > fudge] <- fudge
# d_sum$u[d_sum$u > fudge] <- fudge
# d_sum$l[d_sum$l > fudge] <- fudge

d <- inner_join(d, d_last)

d$last_value[d$last_value > fudge] <- fudge
# d$value[d$value > fudge] <- fudge


cols <- brewer.pal(5, "RdBu")
cols <- c(cols[1], "grey50", cols[length(cols)])
g <- ggplot(d_sum, aes_string("year", "median_value")) +
  facet_grid(mp_name~variable, labeller = label_parsed) +
  geom_ribbon(aes(ymin = ll, ymax = uu), fill = "grey90") +
  geom_ribbon(aes(ymin = l, ymax = u), fill = "grey70") +
  ggsidekick::theme_sleek() +
  geom_line(lwd = 1.5) +
  coord_cartesian(ylim = c(0, 4)) +
  guides(colour = FALSE) +
  xlim(25, 50) +
  geom_hline(yintercept = 1,
    col = "black", lty = 2) +
  ylab("Value") + xlab("Year")
  # geom_line(data = filter(d, iter %in% c(1:10)),
  #   aes(y = value, group = iter),
  #   alpha = 0.4, colour = "blue")
  # scale_colour_gradientn(colours = cols,
  #     values = c(0, 0.8, 1.2, 3))
  # viridis::scale_colour_viridis()
g
```

```{r, fig.asp=1.2}
voi_out <- DLMtool::VOI(short_mse)
```
