\clearpage

# WEST COAST VANCOUVER ISLAND REX SOLE CASE STUDY {#app:mse-rex}

## BACKGROUND

Rex Sole (*Glyptocephalus zachirus*) occur from central Baja California to the western Bering Sea, and are generally distributed throughout coastal BC [@mecklenburg2002]. They have been caught in BC at depths between 20 m and greater than 1000 m, with most captured between 75 m and 450 m. Rex Sole have been caught in BC waters as large as 58 cm and up to 1.44 kg. The only aged Rex Sole from BC are those caught in the Hecate Strait Multispecies Assemblage Bottom Trawl survey in 1998. The oldest Rex Sole aged from BC was a 34 cm female aged at 15 years, though larger, unaged individuals have been caught up to length 58 cm. This species has been aged up to 29 years (female) in the Gulf of Alaska [@abookire2006]. Additional otoliths have been collected on BC surveys from 2000-present although they have yet to be aged.

Rex Sole is a commonly caught flatfish species in BC groundfish bottom trawl surveys and although it is commonly caught in the commercial mixed-species bottom trawl fishery, there is no directed fishery or assigned quota for it. It is commonly caught with Pacific Cod, Dover Sole, English Sole and Arrowtooth Flounder. Rex Sole have never been formally assessed in BC; however, biomass of Rex Sole in Hecate Strait was estimated in 2012 using research survey data collected between 1984 and 2003 [@fargo2012].

Commercial and research catch, effort, and biological data (lengths, weights, ages, maturity) are archived by the Groundfish Data Unit (Fisheries and Oceans Canada, Science Branch, Pacific Region) and housed in a number of relational databases.  Historical commercial catch and effort data from 1954--2006/2007 are housed in GFCatch, PacHarvTrawl, PacHarvHL, and PacHarvSable depending on the fishery and time period. Modern (2006/2007 to present) commercial catch data are housed in GFFOS, a groundfish-specific view of the Fishery Operations System (FOS) database (Fisheries and Oceans Canada, Fisheries and Aquaculture Management, Pacific Region).

In each commercial database there is an official catch table that provides the best available estimate of landed catch per location by applying the proportion of catch per set or area to trip-level landing data. Since 2015, the official catch tables from the various databases have been merged together into one master catch table in GFFOS (`GF_MERGED_CATCH`) to facilitate and standardize commercial data extraction. Catch proportions are calculated from the most spatially detailed information available on how much of each species was harvested per fishing tow/set or per area. In most cases this is the catch reported in observer logs or fisher logs. Older data contain records where set-level information was rolled up, for example, by area (see Rutherford (1999) for details on how catch was recorded in databases). These proportions are applied to the best available information on how much of each species was harvested on a trip. In most cases this will be the landed weight as recorded by the Dockside Monitoring Program. Earlier harvest data are recorded from sales slips or observer or fisher logs ([see @rutherford1999] for details on data sources). In 1996, mandatory 100% observer coverage was implemented for the commercial trawl fishery (and in 2006 for the hook and line sectors) improving the reliability of fishery data.

Research survey data and commercial biological data from the 1940s to present are housed in GFBio, the Groundfish Biological Samples database. In order to improve data on BC groundfish stocks, fishery-independent synoptic bottom trawl surveys were established in 2003 that are conducted in four areas: the west coast of Vancouver Island, Hecate Strait, Queen Charlotte Sound and the west coast of Haida Gwaii. The surveys alternately cover two areas each year. These survey and observer data are available to provide important time-series and biological data for stock assessment of a broad range of BC groundfish species.

In the US, Rex Sole are caught in the bottom trawl fishery and are considered to form three separate stocks: the Gulf of Alaska stock (GOA), the Bering Sea/Aleutian Islands (BSAI) stock and the West Coast stock from Washington to California. The GOA stock is assessed every four years using an age-structured model and was last fully assessed in 2017 [@mcgilliard2017]. The BSAI stock is assessed as part of the "other flatfish complex" of which Rex Sole and Starry Flounder make up most of the commercial harvest. This stock is also assessed every four years, and was last fully assessed in 2015 [@wilderbuer2015]. The West Coast stock was last assessed in 2013 using "extended simple Stock Synthesis" in which a depletion-based stock reduction type analysis is extended to allow index data (and potentially length and age data) to be used for parameter estimation [@cope2015].

```{r}
library(ggplot2)
library(dplyr)
library(here)
drex <- readRDS(here("generated-data", "rex-filter-data.rds"))
if (!file.exists(here("generated-data/rex-survey-sets.rds"))) {
  dsurv <- gfdata::get_survey_sets("rex sole", ssid = 4)
  saveRDS(dsurv, here("generated-data/rex-survey-sets.rds"))
} else {
  dsurv <- readRDS(here("generated-data/rex-survey-sets.rds"))
}
if (!file.exists(here("generated-data/rex-cpue-spatial.rds"))) {
  dcomm <- gfdata::get_cpue_spatial("rex sole")
  saveRDS(dcomm, here("generated-data/rex-cpue-spatial.rds"))
} else {
  dcomm <- readRDS(here("generated-data/rex-cpue-spatial.rds"))
}
# dsurv <- readRDS(here("../../gfs/report/data-cache/rex-sole.rds"))$survey_sets
# dcomm <- readRDS(here("../../gfs/report/data-cache/rex-sole.rds"))$cpue_spatial
drex$survey_sets <- dsurv
drex$cpue_spatial <- dcomm
plot_multiyear_survey_sets <- function(dat, survey_abbrev,
  density_column = "density_kgpm2",
  density_lab = expression(Density~(kg/km^2)), density_multiplier = 1e6) {
  dd <- gfplot::tidy_survey_sets(dat, survey_abbrev, years = seq(0, 1e6),
    density_column = density_column)
  coast <- gfplot:::load_coastline(range(dd$lon) + c(-1, 1),
    range(dd$lat) + c(-1, 1),
    utm_zone = 9
  )
  ggplot(filter(dd, present == 1), aes(X, Y,
    size = density*density_multiplier,
    fill = density*density_multiplier)) +
    scale_size_area(max_size = 8) +
    geom_point(data = filter(dd, present == 0), pch = 4,
      size = 1, col = "grey60", alpha = 0.5) +
    coord_equal(expand = FALSE, xlim = range(dd$X), ylim = range(dd$Y)) +
    geom_point(pch = 21, alpha = 0.5) +
    facet_wrap(~year) +
    geom_polygon(
      data = coast, aes_string(x = "X", y = "Y", group = "PID"),
      fill = "grey87", col = "grey70", lwd = 0.2, inherit.aes = FALSE) +
    scale_fill_viridis_c(trans = "sqrt") +
    labs(fill = density_lab,
      size = density_lab, x = "Easting",
      y = "Northing") +
    guides(
      size = guide_legend(order = 1),
      fill = guide_colorbar(order = 0)) +
    gfdlm::theme_pbs()
}
```

```{r rex-surv-set-plot, fig.cap="Individual survey tows for the West Coast Vancouver Island synoptic bottom trawl survey. Light gray crosses indicate survey sets that did not catch Rex Sole. The area and colour of the circles are proportional to the density of Rex Sole for that survey set. Eastings and Northings are for UTM zone 9.", fig.asp=1, fig.width = 9, out.width = "\\textwidth"}
plot_multiyear_survey_sets(dsurv, "SYN WCVI")
```

(ref:fig-rex-indexes)
West Coast Vancouver Island synoptic bottom trawl survey and standardized commercial bottom trawl CPUE for Rex Sole standardized according to the methods in @anderson2019synopsis. Each index is centred by its geometric mean for years 2004--2019 for visualization purposes. Dots represent mean estimates and line segments represent 95% confidence intervals. The index in the top panel is derived from the data shown in Figure \@ref(fig:rex-surv-set-plot).

```{r rex-surv-index-plot, fig.cap="(ref:fig-rex-indexes)", fig.width = 5, out.width = "4.3in", fig.asp=1.15}
# survey_cols <- c(RColorBrewer::brewer.pal(5L, "Set1"),
#       RColorBrewer::brewer.pal(8L, "Set1")[7:8],
#       "#303030", "#a8a8a8", "#a8a8a8", "#a8a8a8")
# survey_col_names <- c("SYN WCHG", "SYN HS", "SYN QCS", "SYN WCVI",
#     "HBLL OUT N", "HBLL OUT S", "IPHC FISS", "Commercial",
#     "HBLL INS N", "HBLL INS S", "MSA HS")
# survey_cols <- stats::setNames(survey_cols, survey_col_names)
# drex$survey_index %>%
#   gfplot::tidy_survey_index(survey = "SYN WCVI") %>%
#   gfplot::plot_survey_index(col = c("grey60", "grey20"), survey_cols = survey_cols) +
#   ylab("Survey relative biomass index")
rex_indexes <- readRDS(here("generated-data/rex-indexes.rds"))

d1 <- reshape2::melt(rex_indexes, id.vars = c("year"),
  measure.vars = c("syn_wcvi", "trawl_cpue"), 
  variable.name = "index", value.name = "est") %>% 
  mutate(index = as.character(index)) %>% 
  mutate(index = ifelse(grepl("^syn", index), "SYN WCVI", "Trawl CPUE"))
  
d2 <- reshape2::melt(rex_indexes, id.vars = c("year"),
  measure.vars = c("syn_wcvi_sd", "trawl_sd"), 
  variable.name = "index", value.name = ".sd") %>% 
  mutate(index = as.character(index)) %>% 
  mutate(index = ifelse(grepl("^syn", index), "SYN WCVI", "Trawl CPUE"))
d3 <- inner_join(d1, d2, by = c("year", "index"))

d3 <- group_by(d3, index) %>%
  mutate(est = est / exp(mean(log(est[year >= 2004]), na.rm = TRUE)))

ggplot(d3, aes(year, est)) + 
  # geom_line(na.rm = TRUE) + 
  facet_wrap(~index, ncol = 1) +
  geom_pointrange(aes(ymin = exp(log(est) - 2 * .sd), ymax = exp(log(est) + 2 * .sd)), na.rm = TRUE) + #, position = position_dodge(width = 0.3)
  theme_pbs() + 
  ylab("Index (centred by its geometric mean)")+
  xlab("Year") +
 geom_linerange(aes(ymin = exp(log(est) - 2 * .sd), ymax = exp(log(est) + 2 * .sd)), na.rm = TRUE) +
  geom_point(pch = 21, size = 2, fill = "white", na.rm = TRUE)
```

```{r rex-catch-plot, fig.cap="Commercial catch for Rex Sole. Note that limited catch in the early 1990s is considered unreliable and is not shown. The shaded region prior to 1996 indicates the time period before the at-sea observer program was implemented for bottom and midwater trawl fleets. Depth contours are shown at 100 m, 200 m, and 500 m.", fig.asp = 0.8, fig.width = 5, out.width = "4.5in"}
suppressWarnings({g <- drex$catch %>%
  gfplot::tidy_catch(areas = "3[CD]+") %>%
  gfplot::plot_catch(xlim = c(1954, 2019), unreliable = c(1996))})
g + labs(title = "")
```

```{r rex-cpue-map, fig.cap="Spatial commercial trawl CPUE for Rex Sole for tows that caught any Rex Sole from 2013--2019. Cells are 4 km wide and are only shown in cases where there are at least three unique vessels in a given cell to meet privacy requirements. CPUE is calculated as the weight of catch (landings plus discards) divided by hours fished for all positive tows from the groundfish trawl sector. Trawl data are shown from 2013 onwards after the trawl footprint was frozen.", fig.width = 7.75, out.width = "\\textwidth"}
drex$cpue_spatial %>%
  dplyr::filter(year >= 2013, year <= 2019) %>%
  dplyr::filter(major_stat_area_code %in% c("03", "04")) %>%
  gfplot::plot_cpue_spatial(xlim = c(500, 890), ylim = c(5353, 5700),
    percent_excluded_xy = c(0, 0), bin_width = 4)
```

```{r rex-samples, fig.cap="Specimen availability for Rex Sole. Shown are the number of available fish specimens that have had their length measured, have been weighed, had their maturity assessed, had their age assessed, and for which ageing structures are available for ageing. Blank panels indicate year-measurement combinations without any data. Shading of these cells reflects the relative number of specimens available with the actual number of specimens indicated in the cells to the nearest round number.", fig.asp = 0.6, fig.width = 7, out.width = "6in"}
# viridis::scale_fill_viridis(option = "D", end = 0.82, na.value = na_colour)}
g1 <- drex$survey_samples %>%
  gfplot::tidy_sample_avail(year_range = c(1996, 2019)) %>%
  gfplot::plot_sample_avail(title = "Biological samples") +
  scale_fill_viridis_c(option = "C", na.value = "white", end = 0.82)

g2 <- drex$commercial_samples %>%
  gfplot::tidy_sample_avail(year_range = c(1996, 2019)) %>%
  gfplot::plot_sample_avail(title = "Commercial samples") +
  scale_fill_viridis_c(option = "D", na.value = "white", end = 0.82)

cowplot::plot_grid(g1, g2, nrow = 2)
```

\clearpage

(ref:fig-rex-syn1)
First Rex Sole page from @anderson2019synopsis. (Temporary placeholder until we properly plot out just the relevant data.)

```{r rex-syn1, fig.cap="(ref:fig-rex-syn1)", out.width="6in"}
# knitr::include_graphics(here("images/rex-sole-1.png"))
```

\clearpage

(ref:fig-rex-syn2)
Second Rex Sole page from @anderson2019synopsis. (Temporary placeholder until we properly plot out just the relevant data.)

```{r rex-syn2, fig.cap="(ref:fig-rex-syn2)", out.width="6in"}
# knitr::include_graphics(here("images/rex-sole-2.png"))
```

\clearpage

<!-- Maturity
Abookire 2006 - GOA ML50 females = 352 mm, ML100 = 420 mm) significantly larger size than in Oregon
MA50 = 5.1 years, all mature at age 9 except for two still immature at 9 and 10 years (n=557)
Hosie and Horton 1977 - Oregon female ML50 24 cm, ML100 = 30 cm
MA50 = 5 years, MA100 = 9 years (212 females, 45 unsexed age 1 fish)

Mortality
natural mortality used in GOA assessment 0.17-->

*TODO: Flesh out the sections below*

## STEP 1: DEFINE THE DECISION CONTEXT {#sec:results-rex1}

The decision to be made is which MP to use to determine catch limits for the period until the next available catch advice.
The time-frame for making the decision was stated in the request for science advice.
See Section \@ref(sec:approach1).

*TODO: Complete this section after technical team meetings*

## STEP 2: SELECTION OF OBJECTIVES AND PERFORMANCE METRICS  {#sec:results-rex2}

We defined the objectives for Rex Sole to be the same as those listed in Section \@ref(sec:approach2).

The performance metrics measuring the objectives are:

TODO: fix this:
1. LT LRP: Probability SB > 0.4 *B*~MSY~ (years 36--50)
2. LT USR: Probability SB > 0.8 *B*~MSY~ (years 36--50)
3. FMSY: P(F < *F*~MSY~) (years 1--50)
4. STC: Probability catch > 0.5 MSY (years 1--10)
5. LTC: Probability catch > 0.5 MSY (years 36--50)
6. AAVC: Probability AAVY (average annual variability in catch) < 0.2 (years 1--50)

## STEP 3: SELECTION OF UNCERTAINTIES/SPECIFICATION OF OPERATING MODELS {#sec:results-rex3}

We consider the major axes of uncertainty for Rex Sole to be:

1. The magnitude of the commercial catch prior to 1996;

2. The importance of the commercial CPUE index;

3. The value of the steepness parameter (*h*) of the stock-recruit relationship; and

4. The value of natural mortality (*M*).

5. Selectivity

*TODO: The commercial and survey length selectivity is another possible axis of uncertainty that is not yet explored.*

We defined eight OM scenarios that differed from each other in these respects (Table \@ref(tab:rex-scen)), with all other parameters held at the same values as described in Appendix \@ref(app:desc-om-rex).

```{r rex-scen, results='asis'}
sc <- readRDS(here("generated-data/rex-scenarios.rds"))
sc %>%
  select(-scenario, -order) %>%
csasdown::csas_table(caption = "Rex Sole scenarios", col_names = c("Scenario name", "Category"))
```

### The Reference Set

#### Magnitude of pre-1996 commercial catch and importance of commercial CPUE

Prior to 1996, reported catches for WCVI Rex Sole were much lower than post-1995 and there were no reported discards (Figure \@ref(fig:rex-syn1)).
Assumptions about pre-1996 catch levels affect the SRA model's estimates of the depletion level in 1996 (Appendix \@ref(app:sra)).
The SRA model parameter $\tilde{C}^{\textrm{eq}}_f$, describes the equilibrium catch in weight prior to the first year of the model (1996 for Rex Sole), which is used to calculate equilibrium fishing mortality prior to the first year of the model $F^{\textrm{eq}}_f$, which in turn is used to calculate total mortality $Z^{\textrm{eq}}_a$ needed to calculate recruits and numbers in the first year of the model (Equation C.3).
We note that the use of $F^{\textrm{eq}}_f$ and $\tilde{C}^{\textrm{eq}}_f$ make the assumption that the population biomass and fishery were in equilibrium at that catch level prior to 1996.
While this is likely an unrealistic assumption, it is a convenient means of initializing a population model in the presence of fishing.
For this reason, we treated the value of $\tilde{C}^{\textrm{eq}}_f$ as a major axis of uncertainty.

<!-- *TODO, make equation C.3 a dynamic ref* RF -->

We considered four scenarios that varied in the assumed value of $\tilde{C}^{\textrm{eq}}_f$ (Table \@ref(tab:rex-scen)).

* The scenario "Catch eq. 100%" assumes that equilibrium catch prior to 1996 was the same as that in 1996.

* The scenario "Catch eq. 200%" assumes that equilibrium catch prior to 1996 was twice that in 1996, where the catch could possibly have been underestimated because it was not mandatory to report all landings and discards prior to 1996.

* The scenario "Catch eq. 200% + CPUE" also assumes that equilibrium catch prior to 1996 was twice that in 1996, plus the SRA model is fit to the commercial CPUE index, which is available from 1996, therefore providing a longer index of abundance than the synoptic bottom trawl survey (Figure \@ref(fig:rex-syn1)).

* The scenario "Catch eq. 50%" assumes that equilibrium catch prior to 1996 was half that in 1996, approximating the reported 1995 catch. Unless otherwise stated, all other scenarios use $\tilde{C}^{\textrm{eq}}_f$ = 50%.

*Note: we are planning on exploring the best "default" value for Catch eq. after discussions with the technical team*.

#### Steepness

We considered two alternative scenarios that differed in terms of the steepness of the stock-recruit relationship (Table \@ref(tab:rex-scen)).
Unless otherwise stated, all other scenarios drew from a baseline uniform distribution *h* = 0.7--0.95 (see Section \@ref(app:desc-stock-h-rex)).

* The scenario "*h* = 0.5--0.7" drew from a uniform distribution of lower steepness values than the baseline.

* The scenario "*h* = 95" fixed steepness at a higher value than the baseline.

#### Natural Mortality

We considered one alternative scenario that differed in terms of the fixed value of natural mortality (Table \@ref(tab:rex-scen)).
Unless otherwise stated, all other scenarios drew from a baseline uniform distribution *M* = 0.14--0.2 *y*^-1^, which is centred around the value of 0.17 *y*^-1^ used for the Gulf of Alaska stock assessment of Rex Sole (@mcgilliard2017, see Section \@ref(app:desc-stock-m-rex)).

* The scenario "M = 0.25 *y*^-1^" considers that *M* could be latitude-dependent and may be higher for stocks in warmer BC waters.

We considered the above seven scenarios to represent the major sources of uncertainty for Rex Sole and grouped them into the "reference set" of OMs (see Section \@ref(sec:best3)).
Results presented in Section \@ref(sec:results-rex6) will be based on average results from the reference set.

### The Robustness Set

In addition, to illustrate application of the framework in the presence of additional sources of structural uncertainty, we included two scenarios with non-stationarity in *M* (Table \@ref(tab:rex-scen)).

* The "Increasing *M*" scenario assumes that *M* increases monotonically from 0.2 to 0.4 *y*^-1^ over the projection period.

* The "Decreasing *M*" scenario assumes *M* decreases monotonically from 0.2 to 0.1 *y*^-1^ over the projection period.

Results from the Robustness Set will be presented separately in Section \@ref(sec:results-rex6) and will be used to show whether performance of MPs is significantly affected by these other sources of uncertainty.

*NOTE: the authors will be running further sensitivity tests to check whether alternative selectivity scenarios need to be included in the robustness set*

### OM Model Outputs

Selectivity-at-length used by all OMs is shown in Figure (\@ref(fig:rex-selectivity)).
Selectivity-at-length is calculated from two parameters: L5, the shortest length corresponding to 5% vulnerability; and LFS, the shortest length that is fully vulnerable to fishing.
Variation in the selectivity ogives comes from the distributions assumed for these two parameters in the OM (See Sections \@ref(app:desc-fleet-l5-rex) and \@ref(app:desc-fleet-lfs-rex)).

Fits to the historical indices of abundance from the nine OMs are shown in Figure (\@ref(fig:rex-survey-fits)).
Estimates of depletion (*SSB*/*SSB*~0~) during the historical period from the nine OMs are shown in Figure (\@ref(fig:rex-depletion-om)).

(ref:fig-rex-survey-fits)
SRA model fits to the SYN WCVI and commercial bottom trial CPUE relative biomass indexes. 
Thin lines represent individual SRA model fits across stochastic draws from the various OM parameters.
Panels from top to bottom represent scenarios.
Dots represent index mean and line segments represent 2 $\times$ the standard errors as entered into the SRA models.
In the case of the commercial CPUE, these standard errors have been inflated 1.5 times from the fitted standard errors to downweight the commercial index relative to the survey index.

```{r rex-survey-fits, fig.cap="(ref:fig-rex-survey-fits)", out.width="0.65\\textwidth"}
knitr::include_graphics(here("report/figure/rex-index-fits.png"))
```

\clearpage

(ref:fig-rex-depletion-om)
Spawning stock biomass ($B$) depletion trajectories for reference and robustness set OMs.
Depletion is represented as a fraction of $B_0$ (spawning stock biomass at unfished equilibrium).
Note that the "M increasing" scenario only represents natural mortality increasing in the future projections---not the historical time period illustrated here.
Lines represent medians, and dark and light grey shading represent 50% and 95% quantiles across simulations.

```{r rex-depletion-om, fig.cap="(ref:fig-rex-depletion-om)", out.width="\\textwidth"}
knitr::include_graphics(here("report/figure/rex-compare-SRA-depletion-panel.png"))
```

\clearpage

## STEP 4: IDENTIFICATION OF CANDIDATE MANAGEMENT PROCEDURES  {#sec:results-rex4}

We started with the full set of candidate MPs described in Appendix \@ref(app:MPs):

```{r rex-mps, results='asis'}
mp <- readr::read_csv(here("analysis", "rex", "mp.txt"), comment = "#")
mp_list <- split(mp, mp$type)
csasdown::csas_table(mp, caption = "Candidate MPs.", col_names = c("Management procedure", "MP type"))
```

We used the `.` version of the MPs, where applicable, to refer to the version of the MPs that only observes the survey index every second year to mimic our biennial WCVI synoptic survey.
Due to the biennial nature of the trawl survey, we set the MPs to be applied every second year.

We set a prior on the intrinsic rate of population increase $r$ in the surplus production models based on...

## STEP 5: SIMULATION OF THE APPLICATION OF THE MANAGEMENT PROCEDURES  {#sec:results-rex5}

```{r}
pm_df_list <- readRDS(here("generated-data/rex-pm-all.rds"))
pm_all <- bind_rows(pm_df_list, .id = "scenario")
pm_avg <- group_by(pm_all, MP) %>%
  summarise_if(is.numeric, mean, na.rm = TRUE)
pm_min <- group_by(pm_all, MP) %>%
  summarise_if(is.numeric, min, na.rm = TRUE)
reference_mp <- c("FMSYref75", "NFref", "FMSYref")


satisficed_criteria <- c("LT LRP" = 0.9, "STC" = 0.8)
# plot_tigure(pm_avg, satisficed = satisficed_criteria)
# plot_tigure(pm_min, satisficed = satisficed_criteria)

mp_sat <- dplyr::filter(pm_min, `LT LRP` > satisficed_criteria[1], `STC` > satisficed_criteria[2]) %>%
  pull(MP)
mp_sat <- mp_sat[!mp_sat %in% reference_mp]
mp_sat

mp_sat <- mp_sat[!mp_sat %in% c(".SP4010_0.6", ".SP6040_0.6_fox", ".SP6040_0.6")]
mp_sat <- mp_sat[!mp_sat %in% c("CC_hist20")] # similar to "CC1.2"
# mp_sat

mp_sat <- mp_sat[!mp_sat %in% reference_mp]

pm_avg_sat <- pm_avg %>% filter(MP %in% mp_sat)
pm_min_sat <- pm_min %>% filter(MP %in% mp_sat)
```

Before running the final simulations, we ran a set of trial simulations to screen out MPs that did not meet a basic set of criteria, i.e., a satisficing step [@miller2010].
We began by assessing minimum performance across all candidate MPs for the reference set of OMs (Figure \@ref(fig:rex-tigure-min)) to determine which MPs would be carried forward as satisficed MPs.
To obtain a manageable number of MPs for further consideration, we set satisficing thresholds of LT P40 $>$ 0.8 and STY $>$ 0.7.

This left us with `r length(mp_sat)` MPs (`r gfutilities::commify(mp_sat)`).

We ran the closed-loop simulations across 200 stochastic iterations using DLMtool version XX with the OMs and MPs described above.
We assessed convergence of the closed-loop simulation by plotting the cumulative performance metrics as iterations were added (Figure \@ref(fig:rex-converge)).
Some MPs with very similar performance may still be exchanging rank order within specific performance metrics as of 200 iterations.
Therefore, final inference should probably be drawn on somewhat greater than the 200 iterations shown here.
We checked other OMs and these showed similar patterns to the representative  Figure \@ref(fig:rex-converge).

(ref:fig-rex-converge)
Assessing convergence of the Rex Sole closed-loop simulation under an example OM from the reference set with MPs that are later determined to be part of the satisficed set.
Broad differences between MPs have converged (lines no longer cross each other).

```{r rex-converge, fig.cap="(ref:fig-rex-converge)", out.width="\\textwidth"}
knitr::include_graphics(here("report/figure/rex-convergence.png"))
```

## STEP 6: PRESENTATION OF RESULTS AND SELECTION OF MANAGEMENT PROCEDURE  {#sec:results-rex6}

### Reference Set Results

Average performance within the reference set of OMs varied across MPs and performance metrics (Figure \@ref(fig:rex-tigure-avg)).
We can also see some variability in performance within the individual reference set scenarios (Figure \@ref(fig:rex-tigure-panel)).
```{r}
# LT P40 varied between `round(min(pm_avg_sat$"LT P40"), 2)` and `round(max(pm_avg_sat$"LT P40"), 2)` and STY varied between `round(min(pm_avg_sat$STY), 2)` and `round(max(pm_avg_sat$STY), 2)`.
```

Across the categories of MPs, index-slope MPs had the most consistent performance across all six performance metrics (Figure \@ref(fig:rex-spider-all-mps)).
We were unable to obtain reasonable performance out of the surplus production models, but will investigate this further (Figure \@ref(fig:rex-spider-all-mps)).
The constant catch MPs showed clear trade-offs between conservation and fisheries performance metrics and all were "dominated" (exceeded in all performance metric categories) by other MPs (Figure \@ref(fig:rex-spider-all-mps)).
The reference category MPs provide a baseline for considering the performance of the other MPs.

We can look more closely at the average performance metric trade-offs amongst the satisficed MPs (Figure \@ref(fig:rex-spider-satisficed-mps-avg)).
These MPs achieve very similar performance metric values likely because they are very similar in how they are defined (Appendix \@ref(app:MPs)).
These satisficed MPs achieve STY and LTY with close to the same probability as fishing perfectly at F/F~MSY~ or 75% of F/F~MSY~ (Figures \@ref(fig:rex-tigure-panel), \@ref(fig:rex-spider-satisficed-mps-avg), \@ref(fig:rex-spider-satisficed-mps-reference)).

Within the reference set OMs, the "Catch eq. 200%" OM had the most noticeable effect on the yield performance metrics with slightly lower values than in the other scenarios (Figure \@ref(fig:rex-spider-satisficed-mps-reference)).
However, making the same assumption about catch at equilibrium the year before the initial year of the historical period but including commercial CPUE resulted in consistently high conservation performance metric values and slightly higher yield performance metric values than the scenario that did not include commercial CPUE (Figure \@ref(fig:rex-spider-satisficed-mps-reference)).

We can look at timeseries trajectories of SSB/SSB~MSY~, F/F~MSY~, and catch to further understand performance across the various MPs and reference set OMs (Figure \@ref(fig:rex-proj-ceq100)--\@ref(fig:rex-proj-low-h); other trajectories not shown yet).
Although these satisficed MPs mostly perform similarly to each other, by inspecting the projections from MPs that did not make it past the satisficing step, we can see the variety of ways that other MPs failed to achieve the baseline satisficing criteria (Figure \@ref(fig:rex-proj-failed)).

We can also look at "Kobe" plots that demonstrate either the final SSB/SSB~MSY~ vs. F/F~MSY~ status of the various simulations or the trajectory of these status values through time (Figure \@ref(fig:rex-kobe) and \@ref(fig:rex-worm)).

(ref:fig-rex-tigure-avg) Average performance of all candidate MPs across the reference set of OMs.
MPs are ordered by decreasing performance metric values from top to bottom starting with the left-most performance metric and using columns from left to right to break any ties.
The color shading reflects the underlying numbers.

```{r rex-tigure-avg, fig.cap="(ref:fig-rex-tigure-avg)", out.width="3.5in"}
knitr::include_graphics(here("report/figure/rex-tigure-refset-avg.png"))
```

\clearpage

(ref:fig-rex-tigure-min) Minimum performance of all candidate MPs across the reference set of OMs.
This figure is the same as Figure \@ref(fig:rex-tigure-avg) but shows the **minimum** performance metric across the OMs in the reference set for the purposes of applying satisficing rules.
In other words, this figure illustrates the worst performance of each MP across the reference set of OMs.

```{r rex-tigure-min, fig.cap="(ref:fig-rex-tigure-min)", out.width="3.5in"}
knitr::include_graphics(here("report/figure/rex-tigure-refset-min.png"))
```

\clearpage

(ref:fig-rex-tigure-panel) Performance of satisficed MPs for the reference set OMs.
MPs are ordered by decreasing performance metric values from the averaged reference set (Figure \@ref(fig:rex-tigure-min).

```{r rex-tigure-panel, fig.cap="(ref:fig-rex-tigure-panel)", out.width="0.8\\textwidth"}
knitr::include_graphics(here("report/figure/rex-tigure-refset.png"))
```

\clearpage

```{r rex-dot-lines, fig.cap="Dots on line plots of performance metrics across scenarios.", out.width="\\textwidth"}
knitr::include_graphics(here("report/figure/rex-dot-refset-avg.png"))
```

\clearpage

```{r rex-tradeoff-reference, fig.cap="Trade-off plot between...", out.width="\\textwidth"}
knitr::include_graphics(here("report/figure/rex-tradeoff-refset.png"))
```

\clearpage

```{r rex-spider-satisficed-mps-avg, fig.cap="Average performance metrics for satisficed MPs for the reference set of OMs.", out.width="5in"}
knitr::include_graphics(here("report/figure/rex-radar-refset-avg.png"))
```

\clearpage

```{r rex-proj-index, fig.cap="Index projections TODO", out.width="\\textwidth"}
knitr::include_graphics(here("report/figure/rex-projections-index.png"))
```

\clearpage

(ref:fig-rex-proj-scenarios) Same as Figure \@ref(fig:rex-proj-ceq200) etc. but showing all scenarios at once.

```{r rex-proj-scenarios, fig.cap="(ref:fig-rex-proj-scenarios)", out.width="\\textwidth"}
knitr::include_graphics(here("report/figure/rex-projections-scenarios-ref.png"))
```

\clearpage

(ref:fig-rex-proj-ceq100) Historical and projected SSB/SSB~MSY~, F/F~MSY~, and catch across satisficed and reference MPs and the "Ceq. 200%" OM.
Dark line indicates the median value and the darker and lighter shaded ribbons indicate the 50% and 90% quantiles.
Thin gray lines represent illustrative simulation iterations.
The vertical dashed line indicates the last year of the historical period.
The horizontal dashed lines indicate SSB/SSB~MSY~ = 1, 0.8, and 0.4; F/F~MSY~ = 1; and catch = catch from the last historical year.

```{r rex-proj-ceq200, fig.cap="(ref:fig-rex-proj-ceq100)", out.width="6.5in"}
knitr::include_graphics(here("report/figure/rex-projections-ceq200.png"))
```

(ref:fig-rex-proj-ceq250-cpue) Same as Figure \@ref(fig:rex-proj-ceq200) but for the OM "Ceq. 250%".

```{r rex-proj-ceq250-cpue, fig.cap="(ref:fig-rex-proj-ceq250-cpue)", out.width="6.5in"}
knitr::include_graphics(here("report/figure/rex-projections-ceq250.png"))
```

(ref:fig-rex-proj-high-m) Same as Figure \@ref(fig:rex-proj-ceq200) but for the OM "Higher M".

```{r rex-proj-high-m, fig.cap="(ref:fig-rex-proj-high-m)", out.width="6.5in"}
knitr::include_graphics(here("report/figure/rex-projections-high-m.png"))
```

(ref:fig-rex-proj-high-h) Same as Figure \@ref(fig:rex-proj-ceq200) but for the OM "Higher steepness".

```{r rex-proj-high-h, fig.cap="(ref:fig-rex-proj-high-h)", out.width="6.5in"}
knitr::include_graphics(here("report/figure/rex-projections-high-h.png"))
```

(ref:fig-rex-proj-low-sel) Same as Figure \@ref(fig:rex-proj-ceq200) but for the OM "Lower selectivity".

```{r rex-proj-low-sel, fig.cap="(ref:fig-rex-proj-low-sel)", out.width="6.5in"}
knitr::include_graphics(here("report/figure/rex-projections-sel1.png"))
```

(ref:fig-rex-proj-no-cpue) Same as Figure \@ref(fig:rex-proj-ceq200) but for the OM "No CPUE Ceq. 250%".

```{r rex-proj-no-cpue, fig.cap="(ref:fig-rex-proj-no-cpue)", out.width="6.5in"}
knitr::include_graphics(here("report/figure/rex-projections-no-cpue.png"))
```

\clearpage

(ref:fig-rex-kobe) B/B~MSY~ and F/F~MSY~ values from the final year of the projections across all iterations.
Dots represent individual iterations.
Contour lines indicate two-dimensional kernel-density-smoothed quantiles at 0.10, 0.25, and 0.50 levels, calculated in log space.

```{r rex-kobe, fig.cap="(ref:fig-rex-kobe)", out.width="\\textwidth"}
knitr::include_graphics(here("report/figure/rex-kobe.png"))
```

\clearpage

(ref:fig-rex-worm) Trajectory of B/B~MSY~ and F/F~MSY~ values summarized across iterations.
The solid line corresponds to the median value.
Each diamond represents the 80% quantile of B/B~MSY~ (horizontal) and F/F~MSY~ (vertical).

```{r rex-worm, fig.cap="(ref:fig-rex-worm)", out.width="\\textwidth"}
knitr::include_graphics(here("report/figure/rex-worms-proj.png"))
```

\clearpage

### Robustness Set Results

With the exception of the GB_slope MPs, the satisficed MPs were relatively robust to linear increases in natural mortality in the projection period (Figure \@ref(fig:rex-spider-satisficed-mps-robust) and \@ref(fig:rex-tigure-panel-rob)).
However, all satisficed MPs had a lower probability of achieving yield performance metrics if natural mortality linearly decreasing in the projection period (Figure \@ref(fig:rex-spider-satisficed-mps-robust) and \@ref(fig:rex-tigure-panel-rob)).
The Iratio2 MP achieved the highest AAVY, LTY, and STY performance metrics in the M increasing scenario, while maintaining virtually identical conservation performance metrics as the other MPs (Figure \@ref(fig:rex-spider-satisficed-mps-robust), dark green line).

(ref:fig-rex-tigure-panel-rob) Performance of satisficed MPs for the robustness set OMs.

```{r rex-tigure-panel-rob, fig.cap="(ref:fig-rex-tigure-panel-rob)", out.width="5.5in"}
knitr::include_graphics(here("report/figure/rex-tigure-robset.png"))
```

```{r rex-dots-satisficed-mps-robust, fig.cap="TODO.", out.width="0.9\\textwidth"}
knitr::include_graphics(here("report/figure/rex-dot-robset.png"))
```

```{r rex-tradeoff-robust, fig.cap="Trade-off plot between...", out.width="6in"}
knitr::include_graphics(here("report/figure/rex-tradeoff-robset.png"))
```

```{r rex-spider-satisficed-mps-robust, fig.cap="Performance metrics for satisficed MPs for the individual OMs in the robustness set. Colours are the same as in the average spider plot figure (legend to be added TODO).", out.width="\\textwidth"}
knitr::include_graphics(here("report/figure/rex-radar-robset.png"))
```

(ref:fig-rex-proj-no-cpue-light) Same as Figure \@ref(fig:rex-proj-ceq200) but for the OM "No CPUE Ceq. 50%".

```{r rex-proj-no-cpue-light, fig.cap="(ref:fig-rex-proj-no-cpue-light)", out.width="6.5in"}
knitr::include_graphics(here("report/figure/rex-projections-no-cpue-light.png"))
```

(ref:fig-rex-proj-inc-m) Same as Figure \@ref(fig:rex-proj-ceq200) but for the OM "Increasing M".

```{r rex-proj-inc-m, fig.cap="(ref:fig-rex-proj-inc-m)", out.width="6.5in"}
knitr::include_graphics(here("report/figure/rex-projections-inc-m.png"))
```

\clearpage

### Sensitivity Tests

The closed-loop simulation results demonstrate that conservation and catch metrics are generally insensitive to the range of operating model parameter values explored within a given operating model with the exception of the depletion in the final historical year (D) (Figure \@ref(fig:rex-sens-bbmsy)--\@ref(fig:rex-proj-sens-ffmsy)).
We note that the sensitivity demonstrated here is sensitivity to the range of parameter values within an already conditioned OM.
Changing some of these parameter values prior to fitting the conditioning SRA model would demonstrate sensitivity in some cases (as demonstrated by the OM scenarios).


(ref:fig-rex-sens-bbmsy)
The sensitivity of SSB/SSB~MSY~ in years 36--50 of the projection (y-axis) to OM parameter values (x-axis).
This example uses the "Catch eq. 100%" OM.
A variety of MPs are illustrated across rows.
Each point corresponds to simulation iteration and the solid lines correspond to a loess smoother.

```{r rex-sens-bbmsy, fig.cap="(ref:fig-rex-sens-bbmsy)", out.width="\\textwidth"}
# knitr::include_graphics(here("report/figure/rex-sensitivity-bbmsy-base.png"))
```

(ref:fig-rex-sens-yield)
Same as Figure \@ref(fig:rex-sens-bbmsy) but for mean catch in years 6--20 of the projection.

```{r rex-sens-yield, fig.cap="(ref:fig-rex-sens-yield)", out.width="\\textwidth"}
# knitr::include_graphics(here("report/figure/rex-sensitivity-yield-base.png"))
```

\clearpage

(ref:fig-rex-proj-sens-bbmsy)
The sensitivity of SSB/SSB~MSY~ (y-axis) to high and low values (colours) of various OM parameters (columns) over time.
This example uses the "Catch eq. 100%" OM.

```{r rex-proj-sens-bbmsy, fig.cap="(ref:fig-rex-proj-sens-bbmsy)", out.width="\\textwidth"}
# knitr::include_graphics(here("report/figure/rex-sensitivity-traj-bbmsy-base.png"))
```

\clearpage

(ref:fig-rex-proj-sens-ffmsy)
The sensitivity of F/F~MSY~ (y-axis) to high and low values (colours) of various OM parameters (columns) over time.
This example uses the "Catch eq. 100%" OM.

```{r rex-proj-sens-ffmsy, fig.cap="(ref:fig-rex-proj-sens-ffmsy)", out.width="\\textwidth"}
# knitr::include_graphics(here("report/figure/rex-sensitivity-traj-ffmsy-base.png"))
```
