\clearpage

FIXME: the following code chunks have been mostly commented out and current development is happening in `analysis/rex/`.

```{r, echo=FALSE, message=FALSE, warning=FALSE, results='hide'}
if (!file.exists(here::here("generated-data", "rex-om-sra.rds"))) {
  source(here::here("sra/sra-data-rex.R"))
}
library(DLMtool)
library(dplyr)
library(ggplot2)
library(gfdlm)
library(MSEtool)
```

# REX SOLE CASE STUDY: RESULTS

```{r}
mp <- readr::read_csv(here::here("report", "mp.txt"), comment = "#")
mp_list <- split(mp, mp$type)
csasdown::csas_table(mp, caption = "MPs")
```

West Coast Vancouver Island Rex Sole
  
The performance metrics are defined as:

1. LT P40: Probability SB > 0.4 SB~MSY~ (years 36--50)
1. LT P80: Probability SB > 0.8 SB~MSY~ (years 36--50)
1. PNOF: Probability of not overfishing P(F < F~FMSY~) (years 1--50)
1. LTY: Probability yield > 0.5 MSY (years 36--50)
1. STY: Probability yield > 0.5 MSY (years 6--20)
1. AAVY: Probability AAVY (average annual variability in yield) < 0.2 (years 1--50)

where SB is spawning biomass.
  
```{r}
omrex_sra <- readRDS(here::here("generated-data", "rex-sra.rds"))
omrex <- omrex_sra@OM
omrex@interval <- 2
omrex@nsim <- 48
```

```{r}
# rex_historical <- runMSE(omrex, Hist = TRUE, parallel = FALSE)
```

```{r, fig.cap="Historical trajectories from the Rex Sole WCVI operating model. Light shaded region represents the upper and lower bounds of the historical simulation. Thin grey lines represent 50 draws from the simulation. The numbers are relative to the chosen scale of the simulation.", fig.width=9.5, out.width="5in"}
# catch <- readRDS(here::here("generated-data", "rex-catch.rds"))
# g1 <- gfdlm::plot_historical_ts(rex_historical, observed_ts = catch) +
#   xlab("")
# g2 <- gfdlm::plot_historical_ts(rex_historical, type = "SSB") +
#   ylab("Historical SSB\n(spawning stock biomass)") +
#   xlab("")
# g3 <- gfdlm::plot_historical_ts(rex_historical, type = "Rec") +
#   ylab("Historical recruitment\n(relative numbers)") +
#   xlab("")
# g4 <- gfdlm::plot_historical_ts(rex_historical, type = "Find") +
#   ylab("Historical F\n(fishing mortality)") +
#   xlab("")
# cowplot::plot_grid(g1, g2, g3, g4, ncol = 2, align = "hv")
```

```{r}
file_name <- here::here("generated-data", "rex-mse2.rds")
# omrex@cpars$Data <- NULL # bug
# 
# # sp_debug <- function (x, Data, reps = 1) {
# #   dependencies <- "Data@Cat, Data@Ind"
# #   do_Assessment <- SP(x = x, Data = Data)
# #   Rec <- HCR_MSY(Assessment = do_Assessment, reps = reps)
# #   if (x == 2 && max(Data@Year) > 28) {
# #     print(max(Data@Year))
# #     print(Rec)
# #     plot(do_Assessment)
# #     browser()
# #   }
# #   Rec@Misc <- MSEtool:::Assess_diagnostic(x, Data, do_Assessment, include_assessment = FALSE)
# #   return(Rec)
# # }
# # class(sp_debug) <- "MP"
# # 
# # SP_prior <- MSEtool::SP
# # formals(SP_prior)$use_r_prior <- TRUE
# # class(SP_prior) <- "Assess"
# # SP4010_prior <- MSEtool::make_MP("SP_prior", "HCR_ramp", LRP = 0.1, TRP = 0.4, RP_type = "SSB_SSB0")
# 
# # ---------------------------------------------------------
# 
# # omrex@TACSD <- c(0, 0)
# # omrex@nsim <- 48
# # omrex@seed <- 1
# # omrex@interval <- 2
# # omrex@DR <- 0
# # rex_mse <- runMSE(OM = omrex, MPs = c("FMSYref75"))
# # Data <- rex_mse@Misc$Data[[1]]
# # r_priors <- purrr::map_dbl(1:omrex@nsim, ~mean(MSEtool:::r_prior_fn(.x, Data)))
# # mean(r_priors)
# # sd(r_priors)
# 
# if (!file.exists(file_name)) {
#   DLMtool::setup(cpus = floor(parallel::detectCores()/2))
#   snowfall::sfExport('.SP4010_prior', '.SP6040_prior', '.SP8040_prior')
#   omrex@TACSD <- c(0, 0)
#   omrex@nsim <- 20
#   omrex@seed <- 1
#   omrex@interval <- 2
#   omrex@DR <- 0
#   
#   rex_mse <- runMSE(OM = omrex, MPs = mp$mp[1:2], parallel = FALSE)
#   
#   # gfdlm::plot_projection_ts(rex_mse, type = c("F_FMSY", "B_BMSY"))
#   # gfdlm::plot_projection_ts(rex_mse, type = c("TAC")) + ylim(0, NA)
#   # Data <- rex_mse@Misc$Data[[1]]
#   # matplot(t(Data@Ind), type = "l")
#   # matplot(t(Data@Cat), type = "l")
#   
#   # gfdlm::plot_projection_ts(rex_mse, type = c("TAC"), clip_ylim = 1.5)
#   # gfdlm::plot_projection_ts(rex_mse, type = c("F_FMSY", "B_BMSY"))
#   
# #   sp_debug <- make_MP(SP, HCR_MSY, diagnostic = 'full')
# # MSE <- runMSE(omrex, MPs = "sp_debug", PPD = TRUE)
# # diagnostic_AM(MSE) # convergence diagnostics
# # retrospective_AM(MSE, 1) # Assessment estimates of biomass, F, etc over time
# 
# #   
#   snowfall::sfStop()
#   saveRDS(rex_mse, file = file_name)
# } else {
#   rex_mse <- readRDS(file_name)
# }
# # DLMtool::Converge(rex_mse)
```

```{r, fig.asp=1.2, out.width="3.6in", fig.width=5.8, fig.cap="Performance metric probability table across all MPs that were run for the Rex Sole WCVI closed-loop simulation. The MP rows are ordered by performance metric in the order they appear from left to right and the shading corresponds to the probability value indicated in each cell. In future plots we retain only ``satisficed'' MPs that have LT P40 > 0.8 and STY > 0.5."}
# `LT P40` <- gfdlm::pm_factory("SBMSY", 0.4, c(36, 50))
# `LT P80` <- gfdlm::pm_factory("SBMSY", 0.8, c(36, 50))
# STY <- gfdlm::pm_factory("LTY", 0.5, c(6, 20))
# LTY <- gfdlm::pm_factory("LTY", 0.5, c(36, 50))
# PM <- c("LT P40", "LT P80", "STY", "LTY", "AAVY", "PNOF")
# rex_probs <- gfdlm::get_probs(rex_mse, PM)
# gfdlm::plot_probs(rex_probs)
```

```{r}
# reference_mp <- c("NFref", "FMSYref")
# rex_satisficed <- dplyr::filter(rex_probs, `LT P40` > 0.95, STY > 0.75) %>%
#   arrange(-`LT P40`) %>%
#   pull(MP)
But th# rex_satisficed <- union(rex_satisficed[!rex_satisficed %in% reference_mp], ".IDX")
# rex_satisficed_ref <- union(rex_satisficed, reference_mp)
```

```{r}
# rex_mse_sub <- DLMtool::Sub(rex_mse, MPs = rex_satisficed)
# rex_mse_sub_ref <- DLMtool::Sub(rex_mse, MPs = rex_satisficed_ref)
# rex_satisficed_df <- left_join(tibble(mp = rex_satisficed), mp, by = "mp")
```

```{r, fig.asp=1.6, fig.cap="Timeseries projections for the Rex Sole WCVI closed-loop simulation. Solid blue line indicates median; darker and lighter shaded blue indicate 50\\% and 90\\% quantiles. Thin grey lines illustrate 3 sample iterations from the simulation. Horizontal light grey lines represent values of 1.0 for F/F~MSY~ and 0.8, and 0.4 for B/B~MSY~.", out.width="5in", fig.width=7.1}
# g1 <- gfdlm::plot_projection_ts(rex_mse_sub_ref, type = c("SSB", "FM"), n_samples = 3) +
#   ggplot2::coord_cartesian(expand = FALSE, ylim = c(0, 4.5)) +
#   ggplot2::scale_y_continuous(breaks = c(1, 2, 3, 4)) +
#   ggplot2::theme(strip.text.y = element_blank())
```

```{r, fig.asp=1.4, fig.cap="Timeseries projections for the Rex Sole WCVI closed-loop simulation. Same as previous figure but for total allowable catch (TAC) and catch (C). Y-axis values are not shown because the values are relative to the chosen scale of the simulation.", out.width="5in", fig.width=7.1}
# g2 <- gfdlm::plot_projection_ts(rex_mse_sub_ref, type = c("C"), clip_ylim = 1.5, n_samples = 3) +
#   theme(axis.text.y = ggplot2::element_blank(), axis.ticks.y = ggplot2::element_blank()) +
#   ggplot2::theme(axis.title.y = element_blank()) +
#   ggplot2::geom_hline(yintercept = mean(catch[23:23]), lty = 2)
# 
# cowplot::plot_grid(g1, g2, rel_widths = c(2, 1))
```

```{r, fig.cap="Kobe plots for the Rex Sole WCVI closed-loop simulation. Dots represent individual simulation iterations. B~BMSY~ light grey lines indicate 0.4 and 0.8 values. Contour lines indicate 0.10, 0.25 and 0.50 quantile kernel density estimates. Axes are cut off at maximum values of 3.5 although some simulation iterations extend beyond these boundaries.", fig.asp=0.8, fig.width=8, out.width="5.75in"}
# gfdlm::plot_contours(rex_mse_sub_ref, xlim = c(0, 3.5), ylim = c(0, 3.5), alpha = c(0.1, 0.25, 0.50))
```

```{r}
# rex_probs_sat <- rex_probs %>% filter(MP %in% rex_satisficed) %>% 
#     arrange(`LT P40`, `LT P80`, `STY`)
# dups_df <- rex_probs_sat %>%
#   select(-MP) %>% 
#   mutate(Duplicated = duplicated(.)) %>% 
#   mutate(MP = rex_probs_sat$MP) %>% 
#   `[`(1:nrow(rex_probs_sat),c(8, 1:7))
# 
# mp_unique <- rex_probs_sat[!dups_df$Duplicated,,drop=FALSE] %>% pull(MP)
```

```{r}
# dups_df %>%
#   csasdown::csas_table(caption = "Duplicates in terms of PMs.")
```

```{r, fig.cap="Radar plots for the Rex Sole WCVI closed-loop simulation. Performance metrics are indicated at the end of each ``spoke'' (constant-catch MPs). Coloured lines represent the various management procedures. Only showing MPs with unique PMs.", out.width="4.5in", fig.width=10}
# 
# cols <- viridisLite::viridis(5)
# names(cols) <- paste0("CC", seq(60, 100, 10))
# filter(mp, type == "Constant catch") %>%
#   filter(grepl("^CC[0-9]+", mp)) %>% 
#   pull(mp) %>% 
#   DLMtool::Sub(rex_mse, .) %>% 
#   gfdlm::spider(pm_list = PM, palette = "Set2", lwd = 1.0) +
#   scale_color_manual(values = cols) +
#   labs(colour = "MP")
```

<!-- TODO: allow passing factor levels to fix order of MPs -->

```{r, fig.cap="Radar plots for the Rex Sole WCVI closed-loop simulation. Performance metrics are indicated at the end of each ``spoke''. Coloured lines represent the various management procedures. Only showing MPs with unique PMs.", out.width="4.5in", fig.width=10}

# # rex_satisficed_df %>%
# #   pull(mp) %>%
# # mp_unique %>%
#   # union(c("NFref", "FMSYref")) %>%
#   
# c(".Itarget1", ".Itarget2", ".Itarget3", ".GB_slope6_1") %>% 
#   DLMtool::Sub(rex_mse, .) %>%
#   gfdlm::spider(pm_list = PM, palette = "Set2", lwd = 1.0) +
#   scale_color_viridis_d() +
#   # scale_color_manual(values =
#   #     c(RColorBrewer::brewer.pal(length(mp_unique), "Set2"), "grey30", "grey65")) +
#   labs(colour = "MP")
```
